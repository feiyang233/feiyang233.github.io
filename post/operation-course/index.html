<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"feiyang233.club","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="This blog is for record what I learn from this Operation Course">
<meta property="og:type" content="article">
<meta property="og:title" content="Operation Course Record">
<meta property="og:url" content="http://feiyang233.club/post/operation-course/index.html">
<meta property="og:site_name" content="feiyang&#39;s blog">
<meta property="og:description" content="This blog is for record what I learn from this Operation Course">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200216173928.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125517.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125522.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200301123058.png">
<meta property="article:published_time" content="2020-02-13T10:56:35.000Z">
<meta property="article:modified_time" content="2021-06-12T02:30:59.000Z">
<meta property="article:author" content="feiyang">
<meta property="article:tag" content="shell">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200216173928.png">

<link rel="canonical" href="http://feiyang233.club/post/operation-course/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Operation Course Record | feiyang's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">feiyang's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">费洋的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://feiyang233.club/post/operation-course/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/feiy.gif">
      <meta itemprop="name" content="feiyang">
      <meta itemprop="description" content="南洋打工人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="feiyang's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Operation Course Record
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-13 18:56:35" itemprop="dateCreated datePublished" datetime="2020-02-13T18:56:35+08:00">2020-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-12 10:30:59" itemprop="dateModified" datetime="2021-06-12T10:30:59+08:00">2021-06-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/post/operation-course/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="post/operation-course/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This blog is for record what I learn from this <a target="_blank" rel="noopener" href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=42#/detail/pc?id=1546">Operation Course</a></p>
<span id="more"></span>
<h1 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h1><h2 id="SHORTCUTS"><a href="#SHORTCUTS" class="headerlink" title="SHORTCUTS"></a>SHORTCUTS</h2><p>Ctrl + r：find the histroy<br>Ctrl + l：clear the terminal<br>Ctrl + a \ Ctrl + e：move to head \ end in row<br>Ctrl + w \ Ctrl + k：delete before \ after cursor</p>
<p>ZZ : VIM save and quit</p>
<p>Ctrl+C: Interrupt (kill) the current foreground process running in in the terminal. This sends the SIGINT signal to the process, which is technically just a request—most processes will honor it, but some may ignore it.<br>Ctrl+Z: Suspend the current foreground process running in bash. This sends the SIGTSTP signal to the process. To return the process to the foreground later, use the fg process_name command.<br>Ctrl+D: Close the bash shell. This sends an EOF (End-of-file) marker to bash, and bash exits when it receives this marker. This is similar to running the exit command.</p>
<p>top SHORTCUTS  </p>
<p>Shift + p：Sort by CPU<br>Shift + m：Sort by Memory</p>
<h2 id="find-large-file"><a href="#find-large-file" class="headerlink" title="find large file"></a>find large file</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">du -x --max-depth=1 / |sort -k1 -nr</span><br><span class="line">du -x -d 1 -h / |sort -k1 -nr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">find <span class="built_in">which</span> folder has most inode</span></span><br><span class="line">find -type f | awk -F / -v OFS=/ &#x27;&#123;$NF=&quot;&quot;;dir[$0]++&#125;END&#123;for(i in dir)print dir[i]&quot; &quot;i&#125;&#x27;| sort -k1 -nr | head</span><br><span class="line"></span><br><span class="line">769 ./wrk/obj/openssl-1.1.1b/test/</span><br><span class="line">551 ./.cache/mozilla/firefox/hha91z74.default-release/cache2/entries/</span><br><span class="line">462 ./wrk/obj/openssl-1.1.1b/doc/man3/</span><br><span class="line">229 ./wrk/obj/LuaJIT-2.1.0-beta3/src/</span><br><span class="line">212 ./wrk/obj/openssl-1.1.1b/test/certs/</span><br><span class="line">207 ./wrk/obj/openssl-1.1.1b/apps/</span><br><span class="line">199 ./wrk/obj/openssl-1.1.1b/crypto/asn1/</span><br><span class="line">194 ./.cache/gnome-software/icons/</span><br><span class="line">185 ./wrk/obj/openssl-1.1.1b/crypto/evp/</span><br><span class="line">157 ./wrk/obj/openssl-1.1.1b/test/recipes/</span><br></pre></td></tr></table></figure>
<h2 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">find consumer.xml file and replace all aaaaaa to bbbbbb</span></span><br><span class="line">find ./ -type f -name consumer.xml -exec sed -i &quot;s/aaaaaa/bbbbbb/g&quot; &#123;&#125; \;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">find all .txt file and compress <span class="keyword">then</span> copy to /home/.</span></span><br><span class="line">(find . -name &quot;*.txt&quot;|xargs tar -cvf test.tar) &amp;&amp; cp -f test.tar /home/.</span><br></pre></td></tr></table></figure>

<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network status</span></span><br><span class="line">netstat -n | awk &#x27;/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get IP</span> </span><br><span class="line">ip a|grep &quot;global&quot;|awk &#x27;&#123;print $2&#125;&#x27;| awk -F/ &#x27;&#123;print $1&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/IRQq3h4mur60rjVfcLsBzA">Nginx是什么？能干什么？</a></li>
</ol>
<h2 id="cpu-affinity"><a href="#cpu-affinity" class="headerlink" title="cpu affinity"></a>cpu affinity</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_cpu_affinity</span> auto</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity">offical document</a></p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>Add in kernel 2.6</p>
<ol>
<li>epoll’s event flow model is thread-safe;</li>
<li>epoll follow the selection model and improve efficiency;</li>
<li>epoll is event-driven. You can select the relevant state of the entire file to be scanned according to your needs. epoll avoids replacing the scanned file according to the event. You can directly call the callback function, which is more efficient.</li>
<li>Removed the maximum limit on the number of file sizes that can be monitored by the temporary process inside the select model (1024). If you have used an earlier version of Apache, the selection model it uses will be delayed when the request exceeds 1000. The request is wrong, and the performance will be significantly improved by using Nginx.</li>
<li>In addition, an optimization place involved in the events {} configuration is worker_connections, which is also set in events. Through the above learning, we know the role of the worker thread, and the connections supported by each worker thread are Limited, it will be set to 1024 by default here, and when we are dealing with high concurrency scenarios, it is often too low to split worker threads to 1024. It is recommended that you increase the worker_connections, you can refer to the actual business needs Nginx processing Maximum to increase this setting.</li>
</ol>
<h2 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200216173928.png"><br>refer <a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile">docs</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /video/ &#123;</span><br><span class="line">    <span class="attribute">sendfile</span>       <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span>     <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">aio</span>            <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h2><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html">docs</a></p>
<ol>
<li><code>gzip on</code> is responsible for turning on the compression function of the backend;</li>
<li><code>gzip_buffer 16 8k</code> means to set the memory space of Nginx when processing file compression;</li>
<li><code>gzip_comp_level 6</code> indicates the compression level of Nginx when processing compression. Generally, the higher the level, the larger the compression ratio. However, it does not mean that the larger the compression ratio, the better. It is still necessary to choose a suitable compression ratio according to the actual situation. The compression ratio is too large. Affects performance. Compression ratio is too small to achieve the desired effect. Generally, it is recommended that you set it to 6 to be more appropriate.</li>
<li><code>gzip_http_version 1.1</code> means only compress the HTTP 1.1 version of the protocol;</li>
<li><code>gzip_min_length 256</code> means that compression is performed only when the length is greater than the minimum 256 bytes, and if it is less than this length, no compression is performed;</li>
<li><code>gzip_proxied any</code> means that Nginx as a reverse proxy sets some gzip compression policies based on the information returned by the backend server;</li>
<li><code>gzip_vary on</code> indicates whether to send Vary: Accept_Encoding response header field, to realize that the receiver server is gzip compressed;</li>
<li><code>application / vnd.ms-fontobject image / x-icon</code>; gip compression type;</li>
<li>g<code>zip_disable &quot;msie6&quot;</code>; Turn off compression for IE6.</li>
</ol>
<h2 id="Timing-Variables"><a href="#Timing-Variables" class="headerlink" title="Timing Variables"></a>Timing Variables</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html?&_ga=2.258153418.1195201124.1581934594-512055108.1581845805#var_request_time">request_time</a> – Full request time, starting when NGINX reads the first byte from the client and ending when NGINX sends the last byte of the response body</li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&_ga=2.258153418.1195201124.1581934594-512055108.1581845805#var_upstream_connect_time">upstream_connect_time</a> – Time spent establishing a connection with an upstream server</li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&_ga=2.57291882.1195201124.1581934594-512055108.1581845805#var_upstream_header_time">upstream_header_time</a> – Time between establishing a connection to an upstream server and receiving the first byte of the response header</li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&_ga=2.258153418.1195201124.1581934594-512055108.1581845805#var_upstream_response_time">upstream_response_time</a> – Time between establishing a connection to an upstream server and receiving the last byte of the response body</li>
</ul>
<h2 id="nginx-cache"><a href="#nginx-cache" class="headerlink" title="nginx cache"></a>nginx cache</h2><ol>
<li><p>ssl_session_cache</p>
</li>
<li><p>open_file_cache</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">index</span> index.htm index.html;</span><br><span class="line">    <span class="attribute">expires</span> max;  </span><br><span class="line">    <span class="attribute">open_file_cache</span> max=<span class="number">1000</span> inactive=<span class="number">20s</span>; </span><br><span class="line">    <span class="attribute">open_file_cache_valid</span> <span class="number">30s</span>; </span><br><span class="line">    <span class="attribute">open_file_cache_min_uses</span> <span class="number">2</span>; </span><br><span class="line">    <span class="attribute">open_file_cache_errors</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>proxy_cache_path</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_path</span> /path/to/cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=my_cache:<span class="number">10m</span> max_size=<span class="number">10g</span> inactive=<span class="number">60m</span> location / &#123;</span><br><span class="line">        <span class="attribute">proxy_cache</span> my_cache;</span><br><span class="line">        …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="load-balance"><a href="#load-balance" class="headerlink" title="load balance"></a>load balance</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125517.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125522.png"><br>nginx LB general config like follow</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        …</span><br><span class="line">        <span class="section">upstream</span> app_servers &#123;</span><br><span class="line">                 <span class="attribute">server</span> ip1:port1;</span><br><span class="line">                 <span class="attribute">server</span> ip2:port2;</span><br><span class="line">                 <span class="attribute">server</span> ip3:port3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">         …</span><br><span class="line">              <span class="section">location</span> / &#123;</span><br><span class="line">                      <span class="attribute">proxy_pass</span> http://app_servers; </span><br><span class="line">              &#125;</span><br><span class="line">        ….</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>real ip</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Host forward</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span> ;</span><br><span class="line"><span class="attribute">proxy</span> set_header Host www.vipumi.com; </span><br></pre></td></tr></table></figure>
</li>
<li><p>session miss</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip_hash</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        …</span><br><span class="line">        <span class="section">upstream</span> app_servers &#123;</span><br><span class="line">                 ip_hash;</span><br><span class="line">                 <span class="attribute">server</span> ip1:port1;</span><br><span class="line">                 <span class="attribute">server</span> ip2:port2;</span><br><span class="line">                 <span class="attribute">server</span> ip3:port3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">         …</span><br><span class="line">              <span class="section">location</span> / &#123;</span><br><span class="line">                  <span class="attribute">proxy_pass</span> http://app_servers; </span><br><span class="line">              &#125;</span><br><span class="line">        ….</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL_hash</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        …</span><br><span class="line">        <span class="section">upstream</span> app_servers &#123;</span><br><span class="line">            <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">                 <span class="attribute">server</span> ip1:port1;</span><br><span class="line">                 <span class="attribute">server</span> ip2:port2;</span><br><span class="line">                 <span class="attribute">server</span> ip3:port3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">         …</span><br><span class="line">              <span class="section">location</span> / &#123;</span><br><span class="line">                  <span class="attribute">proxy_pass</span> http://app_servers;   </span><br><span class="line">              &#125;</span><br><span class="line">        ….</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># session copy between upstream servers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># session share: store in zookeeper </span></span><br></pre></td></tr></table></figure></li>
<li><p>live ping</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use taobao Tengine module</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;  //定义检查间隔、周期、时间</span><br><span class="line"><span class="attribute">check_keepalive_requests</span> <span class="number">100</span>;  //一个连接发送的请求数</span><br><span class="line"><span class="attribute">check_http_send</span> “HEAD / HTTP/<span class="number">1</span>.<span class="number">1</span>\r\nConnection: keep-alive\r\n\r\n”; //定义健康检查方式</span><br><span class="line"><span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;  //判断后端返回状态码</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="dynamic-upstream"><a href="#dynamic-upstream" class="headerlink" title="dynamic upstream"></a>dynamic upstream</h1><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200301123058.png"></p>
<h2 id="nginx-config"><a href="#nginx-config" class="headerlink" title="nginx config"></a>nginx config</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  logs/<span class="literal">error</span>.log  <span class="literal">info</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> upstreams <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> local &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:81</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:82</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:83</span>;</span><br><span class="line">        <span class="attribute">balancer_by_lua_file</span> <span class="string">&quot;./ngx_lua/upstream.lua&quot;</span>;</span><br><span class="line">        <span class="comment">#check interval=3000 rise=2 fall=5 timeout=1000;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">800</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://local;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> = /ups &#123;</span><br><span class="line">            <span class="attribute">default_type</span>  text/plain;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> <span class="string">&quot;./ngx_lua/upsops.lua&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> = /ups/check &#123;</span><br><span class="line">            <span class="attribute">default_type</span>  text/plain;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> <span class="string">&quot;./ngx_lua/srvcheck.lua&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>upstream.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> ups = ngx.shared.upstreams;</span><br><span class="line"><span class="keyword">local</span> upstream = <span class="built_in">require</span> <span class="string">&quot;ngx.upstream&quot;</span></span><br><span class="line"><span class="keyword">local</span> get_servers = upstream.get_servers</span><br><span class="line"><span class="keyword">local</span> set_peer_down = upstream.set_peer_down</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> curr_ups = upstream.current_upstream_name()</span><br><span class="line"><span class="keyword">local</span> srvs = get_servers(curr_ups)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 摘除主节点的服务节点，传入的addr对应于主节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_primary_server_down</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_primary_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">false</span>,peer.id,<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; failed to set peer down: &quot;</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 摘除备份节点的服务节点，传入的addr对应于备份节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_backup_server_down</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_backup_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">true</span>,peer.id,<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; failed to set peer down: &quot;</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 恢复主节点的服务节点，传入的addr对应于主节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_primary_server_up</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_primary_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">false</span>,peer.id,<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; failed to set peer down: &quot;</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 恢复备份节点的服务节点，传入的addr对应于备份节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_backup_server_up</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_backup_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">true</span>,peer.id,<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; failed to set peer down: &quot;</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,peer <span class="keyword">in</span> <span class="built_in">ipairs</span>(srvs) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> isdown = ups:get(peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">    <span class="comment">-- 摘除服务节点</span></span><br><span class="line">    <span class="keyword">if</span> isdown == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> peer.backup == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- peer.addr: socket 地址，可能是Lua字符串或lua字符串的数组.</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_primary_server_down(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down success.&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down failed.&quot;</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_primary_server_down(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down success.&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down failed.&quot;</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> peer.backup == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_backup_server_down(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down success.&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down failed.&quot;</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_backup_server_down(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down success.&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set down failed.&quot;</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 恢复服务节点</span></span><br><span class="line">    <span class="keyword">elseif</span> isdown == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> peer.backup == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_primary_server_up(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ups:delete(peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up success.&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up failed.&quot;</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_primary_server_up(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ups:delete(peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up success.&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up failed.&quot;</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> peer.backup == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_backup_server_up(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ups:delete(peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up success.&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up failed.&quot;</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_backup_server_up(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ups:delete(peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up success.&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">&quot; &quot;</span>..peer[<span class="string">&quot;name&quot;</span>]..<span class="string">&quot; set up failed.&quot;</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>upsops.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&quot;cjson&quot;</span>;</span><br><span class="line"><span class="keyword">local</span> upstream = <span class="built_in">require</span> <span class="string">&quot;ngx.upstream&quot;</span></span><br><span class="line"><span class="keyword">local</span> ups = ngx.shared.upstreams;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> get_upstreams = upstream.get_upstreams</span><br><span class="line"><span class="keyword">local</span> all_ups = upstream.get_upstreams()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> op = ngx.req.get_uri_args()[<span class="string">&quot;op&quot;</span>];</span><br><span class="line"><span class="keyword">local</span> server = ngx.req.get_uri_args()[<span class="string">&quot;server&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> op == <span class="literal">nil</span> <span class="keyword">or</span> server == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;usage: /ups?op=add&amp;server=192.168.56.101:8080&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">down_server</span><span class="params">(upstream_name,server)</span></span></span><br><span class="line">    <span class="keyword">local</span> ret = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> perrs = upstream.get_servers(upstream_name)</span><br><span class="line">    <span class="keyword">local</span> avail = #perrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #perrs <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = perrs[i]</span><br><span class="line">        <span class="keyword">local</span> isdown = ups:get(peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">        <span class="keyword">if</span> isdown == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            avail = avail - <span class="number">1</span></span><br><span class="line">            ngx.<span class="built_in">log</span>(ngx.ERR,<span class="string">&quot;## peer.down: true  ups: &quot;</span>..upstream_name..<span class="string">&quot; peer.name: &quot;</span>..peer.name..<span class="string">&quot; server: &quot;</span>..server..<span class="string">&quot; avail: &quot;</span>..avail)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> peer.name == server <span class="keyword">then</span></span><br><span class="line">            ret = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ret <span class="keyword">then</span></span><br><span class="line">        avail = <span class="number">2</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> avail</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> op == <span class="string">&quot;add&quot;</span> <span class="keyword">then</span></span><br><span class="line">    ups:set(server,<span class="number">0</span>)</span><br><span class="line">    ngx.say(cjson.encode(&#123;code=<span class="string">&quot;A00001&quot;</span>, msg=<span class="string">&quot;add a server success.&quot;</span>,data=&#123;server&#125;&#125;))</span><br><span class="line"><span class="keyword">elseif</span> op == <span class="string">&quot;del&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> isdown = ups:get(server)</span><br><span class="line">    <span class="keyword">if</span> isdown == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        ngx.say(cjson.encode(&#123;code=<span class="string">&quot;A00001&quot;</span>, msg=<span class="string">&quot;del a server success.&quot;</span>,data=&#123;server&#125;&#125;))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">for</span> _,u <span class="keyword">in</span> <span class="built_in">ipairs</span>(all_ups) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> srvs = upstream.get_servers(u)</span><br><span class="line">        <span class="keyword">for</span> i,peer <span class="keyword">in</span> <span class="built_in">ipairs</span>(srvs) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> down_svc = down_server(u,server)</span><br><span class="line">            ngx.<span class="built_in">log</span>(ngx.ERR,<span class="string">&quot;## down_svc: &quot;</span>..down_svc..<span class="string">&quot; upstream: &quot;</span>..u..<span class="string">&quot; server: &quot;</span>..server)</span><br><span class="line">            <span class="keyword">if</span> down_svc &lt; <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,u..<span class="string">&quot; You cat not set peer down: &quot;</span>..peer[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">                ngx.say(cjson.encode(&#123;code=<span class="string">&quot;E00001&quot;</span>, msg=<span class="string">&quot;You cat not set peer down: &quot;</span>..peer[<span class="string">&quot;name&quot;</span>],data=&#123;peer[<span class="string">&quot;name&quot;</span>]&#125;&#125;))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    ups:set(server,<span class="number">1</span>)</span><br><span class="line">    ngx.say(cjson.encode(&#123;code=<span class="string">&quot;A00001&quot;</span>, msg=<span class="string">&quot;del a server success.&quot;</span>,data=&#123;server&#125;&#125;))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    ngx.say(cjson.encode(&#123;code=<span class="string">&quot;E00001&quot;</span>, msg=<span class="string">&quot;do none.&quot;</span>,data=&#123;&#125;&#125;))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>srvcheck.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&quot;cjson&quot;</span>;</span><br><span class="line"><span class="keyword">local</span> ups = ngx.shared.upstreams;</span><br><span class="line"><span class="keyword">local</span> servers = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">pairs</span>(ups:get_keys(<span class="number">0</span>)) <span class="keyword">do</span></span><br><span class="line">   servers[v] = ups:get(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">ngx.say(cjson.encode(&#123;code=<span class="string">&quot;A00001&quot;</span>, msg=<span class="string">&quot;OK&quot;</span>, data=servers&#125;))</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h1><ul>
<li>21 curl exercises <a target="_blank" rel="noopener" href="https://jvns.ca/blog/2019/08/27/curl-exercises/">https://jvns.ca/blog/2019/08/27/curl-exercises/</a></li>
<li>answer <a target="_blank" rel="noopener" href="http://blog.lujun9972.win/blog/2019/09/11/curl%E7%BB%83%E4%B9%A0/">http://blog.lujun9972.win/blog/2019/09/11/curl%E7%BB%83%E4%B9%A0/</a></li>
<li><a target="_blank" rel="noopener" href="https://wsgzao.github.io/post/curl/">https://wsgzao.github.io/post/curl/</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法 </span></span><br><span class="line">curl [option] [url]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最简单的使用，获取服务器内容，默认将输出打印到标准输出中(STDOUT) 中。</span></span><br><span class="line">curl http://www.centos.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 - v 参数可以看到详细解析过程，通常用于 debug</span></span><br><span class="line">curl -v http://www.centos.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl 发送 Get 请求</span></span><br><span class="line">curl URL</span><br><span class="line">curl URL -O 文件绝对路径</span><br><span class="line"> </span><br><span class="line"><span class="comment"># curl 发送 post 请求</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求主体用 json 格式</span></span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/json&#x27;</span> -d @json 文件绝对路径 URL</span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/json&#x27;</span> -d <span class="string">&#x27;json 内容&#x27;</span> URL</span><br><span class="line"><span class="comment"># 请求主体用 xml 格式</span></span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/xml&#x27;</span> -d @xml 文件绝对路径 URL</span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/xml&#x27;</span> -d <span class="string">&#x27;xml 内容&#x27;</span> URL</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置 cookies</span></span><br><span class="line">curl URL --cookie <span class="string">&quot;cookie 内容&quot;</span></span><br><span class="line">curl URL --cookie-jar cookie 文件绝对路径</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置代理字符串</span></span><br><span class="line">curl URL --user-agent <span class="string">&quot;代理内容&quot;</span></span><br><span class="line">curl URL -A <span class="string">&quot;代理内容&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># curl 限制带宽</span></span><br><span class="line">curl URL --limit-rate 速度</span><br><span class="line"> </span><br><span class="line"><span class="comment"># curl 认证</span></span><br><span class="line">curl -u user:<span class="built_in">pwd</span> URL</span><br><span class="line">curl -u user URL</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 只打印 http 头部信息</span></span><br><span class="line">curl -I URL</span><br><span class="line">curl -<span class="built_in">head</span> URL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 末尾参数</span></span><br><span class="line">--progress  显示进度条</span><br><span class="line">--silent    不现实进度条</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不需要修改 / etc/hosts，curl 直接解析 ip 请求域名</span></span><br><span class="line"><span class="comment"># 将 http://example.com 或 https://example.com 请求指定域名解析的 IP 为 127.0.0.1</span></span><br><span class="line">curl --resolve example.com:80:127.0.0.1 http://example.com/</span><br><span class="line">curl --resolve example.com:443:127.0.0.1 https://example.com/</span><br><span class="line"></span><br><span class="line">-X/--request [GET|POST|PUT|DELETE|…]  指定请求的 HTTP 方法</span><br><span class="line">-H/--header                           指定请求的 HTTP Header</span><br><span class="line">-d/--data                             指定请求的 HTTP 消息体（Body）</span><br><span class="line">-v/--verbose                          输出详细的返回信息</span><br><span class="line">-u/--user                             指定账号、密码</span><br><span class="line">-b/--cookie                           读取 cookie  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 典型的测试命令为：</span></span><br><span class="line">curl -v -X POST -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1:8080/user -d<span class="string">&#x27;&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;admin1234&quot;&#125;&#x27;</span>...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 get 请求</span></span><br><span class="line">curl http://www.linuxidc.com/login.cgi?user=test001&amp;password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 post 请求</span></span><br><span class="line">curl -d <span class="string">&quot;user=nickwolfe&amp;password=12345&quot;</span> http://www.linuxidc.com/login.cgi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求主体用 json 格式</span></span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/json&#x27;</span> -d @json 文件绝对路径 URL</span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/json&#x27;</span> -d <span class="string">&#x27;json 内容&#x27;</span> URL</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 请求主体用 xml 格式</span></span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/xml&#x27;</span> -d @xml 文件绝对路径 URL</span><br><span class="line">curl -X POST -H <span class="string">&#x27;content-type: application/xml&#x27;</span> -d <span class="string">&#x27;xml 内容&#x27;</span> URL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送 post 请求时需要使用 - X 选项，除了使用 POST 外，还可以使用 http 规范定义的其它请求谓词，如 PUT,DELETE 等</span></span><br><span class="line">curl -XPOST url</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送 post 请求时，通常需要指定请求体数据。可以使用 - d 或 --data 来指定发送的请求体。</span></span><br><span class="line">curl -XPOST -d <span class="string">&quot;name=leo&amp;age=12&quot;</span> url</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果需要对请求数据进行 urlencode, 可以使用下面的方式：</span></span><br><span class="line">curl -XPOST --data-urlencode <span class="string">&quot;name=leo&amp;age=12&quot;</span> url</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此外发送 post 请求还可以有如下几种子选项：</span></span><br><span class="line">–data-raw</span><br><span class="line">–data-ascii</span><br><span class="line">–data-binary</span><br><span class="line"></span><br><span class="line"><span class="comment"># To retrieve the job config.xml</span></span><br><span class="line">curl -X GET <span class="string">&#x27;&lt;jenkinshost&gt;/job/&lt;jobname&gt;/config.xml&#x27;</span> -u username:API_TOKEN -o &lt;jobname&gt;.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># to use this config to create a new job</span></span><br><span class="line">curl -s -XPOST <span class="string">&#x27;&lt;jenkinshost&gt;/createItem?name=&lt;jobname&gt;&#x27;</span> -u username:API_TOKEN --data-binary @&lt;jobname&gt;.xml -H <span class="string">&quot;Content-Type:text/xml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get all jenkins jobs</span></span><br><span class="line">curl -X GET <span class="string">&#x27;&lt;jenkinshost&gt;/api/json?pretty=true&#x27;</span> -u username:API_TOKEN -o jobs.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># get jenkins view</span></span><br><span class="line">curl -X GET <span class="string">&#x27;&lt;jenkinshost&gt;/view/&lt;viewname&gt;/api/json&#x27;</span> -u username:API_TOKEN -o view.json</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="unixbench-amp-fio"><a href="#unixbench-amp-fio" class="headerlink" title="unixbench &amp; fio"></a>unixbench &amp; fio</h1><p>Install unixbench can refer this <a target="_blank" rel="noopener" href="https://www.ostechnix.com/unixbench-benchmark-suite-unix-like-systems/">https://www.ostechnix.com/unixbench-benchmark-suite-unix-like-systems/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for ubuntu</span></span><br><span class="line"></span><br><span class="line">sudo apt-get install libx11-dev libgl1-mesa-dev libxext-dev perl perl-modules make git</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/kdlucas/byte-unixbench.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> byte-unixbench/UnixBench/</span><br><span class="line"></span><br><span class="line">./Run</span><br><span class="line"></span><br><span class="line"><span class="comment"># output </span></span><br><span class="line">root@ubuntu:/tmp/byte-unixbench/UnixBench<span class="comment"># ./Run </span></span><br><span class="line">make all</span><br><span class="line">make[1]: Entering directory <span class="string">&#x27;/tmp/byte-unixbench/UnixBench&#x27;</span></span><br><span class="line">make distr</span><br><span class="line">make[2]: Entering directory <span class="string">&#x27;/tmp/byte-unixbench/UnixBench&#x27;</span></span><br><span class="line">Checking distribution of files</span><br><span class="line">./pgms  exists</span><br><span class="line">./src  exists</span><br><span class="line">./testdir  exists</span><br><span class="line">./tmp  exists</span><br><span class="line">./results  exists</span><br><span class="line">make[2]: Leaving directory <span class="string">&#x27;/tmp/byte-unixbench/UnixBench&#x27;</span></span><br><span class="line">make programs</span><br><span class="line">make[2]: Entering directory <span class="string">&#x27;/tmp/byte-unixbench/UnixBench&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> <span class="string">&#x27;programs&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory <span class="string">&#x27;/tmp/byte-unixbench/UnixBench&#x27;</span></span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/tmp/byte-unixbench/UnixBench&#x27;</span></span><br><span class="line">sh: 1: 3dinfo: not found</span><br><span class="line"></span><br><span class="line">   <span class="comment">#    #  #    #  #  #    #          #####   ######  #    #   ####   #    #</span></span><br><span class="line">   <span class="comment">#    #  ##   #  #   #  #           #    #  #       ##   #  #    #  #    #</span></span><br><span class="line">   <span class="comment">#    #  # #  #  #    ##            #####   #####   # #  #  #       ######</span></span><br><span class="line">   <span class="comment">#    #  #  # #  #    ##            #    #  #       #  # #  #       #    #</span></span><br><span class="line">   <span class="comment">#    #  #   ##  #   #  #           #    #  #       #   ##  #    #  #    #</span></span><br><span class="line">    <span class="comment">####   #    #  #  #    #          #####   ######  #    #   ####   #    #</span></span><br><span class="line"></span><br><span class="line">   Version 5.1.3                      Based on the Byte Magazine Unix Benchmark</span><br><span class="line"></span><br><span class="line">   Multi-CPU version                  Version 5 revisions by Ian Smith,</span><br><span class="line">                                      Sunnyvale, CA, USA</span><br><span class="line">   January 13, 2011                   johantheghost at yahoo period com</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">   Use directories <span class="keyword">for</span>:</span><br><span class="line">      * File I/O tests (named fs***) = /tmp/byte-unixbench/UnixBench/tmp</span><br><span class="line">      * Results                      = /tmp/byte-unixbench/UnixBench/results</span><br><span class="line">------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>


<p>Install fio <a target="_blank" rel="noopener" href="https://github.com/axboe/fio">https://github.com/axboe/fio</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install fio</span><br><span class="line"></span><br><span class="line"><span class="comment"># run write test</span></span><br><span class="line">feiyang@ubuntu:~$  fio --name=randwrite --ioengine=libaio --iodepth=1 --rw=randwrite --bs=4k --direct=0 --size=512M --numjobs=2 --runtime=240 --group_reporting</span><br><span class="line"></span><br><span class="line">randwrite: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1</span><br><span class="line">...</span><br><span class="line">fio-3.1</span><br><span class="line">Starting 2 processes</span><br><span class="line">randwrite: Laying out IO file (1 file / 512MiB)</span><br><span class="line">randwrite: Laying out IO file (1 file / 512MiB)</span><br><span class="line">Jobs: 2 (f=2)</span><br><span class="line">randwrite: (groupid=0, <span class="built_in">jobs</span>=2): err= 0: pid=1910: Sat Mar 14 12:48:59 2020</span><br><span class="line">  write: IOPS=204k, BW=799MiB/s (838MB/s)(1024MiB/1282msec)</span><br><span class="line">    slat (nsec): min=1929, max=909527, avg=7784.12, stdev=14736.01</span><br><span class="line">    clat (nsec): min=348, max=1920.9k, avg=613.38, stdev=5441.37</span><br><span class="line">     lat (usec): min=2, max=1925, avg= 8.50, stdev=15.99</span><br><span class="line">    clat percentiles (nsec):</span><br><span class="line">     |  1.00th=[   378],  5.00th=[   386], 10.00th=[   390], 20.00th=[   394],</span><br><span class="line">     | 30.00th=[   398], 40.00th=[   402], 50.00th=[   410], 60.00th=[   418],</span><br><span class="line">     | 70.00th=[   430], 80.00th=[   852], 90.00th=[   964], 95.00th=[   988],</span><br><span class="line">     | 99.00th=[  1336], 99.50th=[  1864], 99.90th=[ 22144], 99.95th=[ 31872],</span><br><span class="line">     | 99.99th=[209920]</span><br><span class="line">   bw (  KiB/s): min=432536, max=539248, per=57.01%, avg=466269.00, stdev=49219.22, samples=4</span><br><span class="line">   iops        : min=108134, max=134812, avg=116567.00, stdev=12304.94, samples=4</span><br><span class="line">  lat (nsec)   : 500=78.66%, 750=1.10%, 1000=16.26%</span><br><span class="line">  lat (usec)   : 2=3.64%, 4=0.11%, 10=0.10%, 20=0.03%, 50=0.08%</span><br><span class="line">  lat (usec)   : 100=0.01%, 250=0.01%, 500=0.01%, 750=0.01%</span><br><span class="line">  lat (msec)   : 2=0.01%</span><br><span class="line">  cpu          : usr=1.11%, sys=98.68%, ctx=24, majf=0, minf=18</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwt: total=0,262144,0, short=0,0,0, dropped=0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">  WRITE: bw=799MiB/s (838MB/s), 799MiB/s-799MiB/s (838MB/s-838MB/s), io=1024MiB (1074MB), run=1282-1282msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  sda: ios=0/3020, merge=0/2481, ticks=0/450, in_queue=4, util=30.57%</span><br><span class="line"></span><br><span class="line"><span class="comment"># run read test</span></span><br><span class="line">feiyang@ubuntu:~$  fio --name=randread --ioengine=libaio --iodepth=16 --rw=randread --bs=4k --direct=0 --size=512M --numjobs=4 --runtime=240 --group_reporting</span><br><span class="line">randread: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=16</span><br><span class="line">...</span><br><span class="line">fio-3.1</span><br><span class="line">Starting 4 processes</span><br><span class="line">randread: Laying out IO file (1 file / 512MiB)</span><br><span class="line">randread: Laying out IO file (1 file / 512MiB)</span><br><span class="line">randread: Laying out IO file (1 file / 512MiB)</span><br><span class="line">randread: Laying out IO file (1 file / 512MiB)</span><br><span class="line">Jobs: 4 (f=4): [r(4)][100.0%][r=81.3MiB/s,w=0KiB/s][r=20.8k,w=0 IOPS][eta 00m:00s]</span><br><span class="line">randread: (groupid=0, <span class="built_in">jobs</span>=4): err= 0: pid=1919: Sat Mar 14 12:51:02 2020</span><br><span class="line">   <span class="built_in">read</span>: IOPS=20.4k, BW=79.7MiB/s (83.6MB/s)(2048MiB/25686msec)</span><br><span class="line">    slat (usec): min=65, max=33169, avg=192.80, stdev=110.46</span><br><span class="line">    clat (usec): min=2, max=48551, avg=2939.25, stdev=573.24</span><br><span class="line">     lat (usec): min=92, max=49600, avg=3132.50, stdev=601.03</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[ 2606],  5.00th=[ 2671], 10.00th=[ 2704], 20.00th=[ 2737],</span><br><span class="line">     | 30.00th=[ 2769], 40.00th=[ 2835], 50.00th=[ 2868], 60.00th=[ 2933],</span><br><span class="line">     | 70.00th=[ 2999], 80.00th=[ 3097], 90.00th=[ 3228], 95.00th=[ 3359],</span><br><span class="line">     | 99.00th=[ 3621], 99.50th=[ 3752], 99.90th=[ 5342], 99.95th=[ 9503],</span><br><span class="line">     | 99.99th=[36963]</span><br><span class="line">   bw (  KiB/s): min=17683, max=22104, per=25.00%, avg=20407.93, stdev=962.56, samples=204</span><br><span class="line">   iops        : min= 4420, max= 5526, avg=5101.91, stdev=240.65, samples=204</span><br><span class="line">  lat (usec)   : 4=0.01%, 100=0.01%, 250=0.01%, 500=0.01%, 750=0.01%</span><br><span class="line">  lat (usec)   : 1000=0.01%</span><br><span class="line">  lat (msec)   : 2=0.03%, 4=99.74%, 10=0.18%, 20=0.03%, 50=0.02%</span><br><span class="line">  cpu          : usr=0.04%, sys=63.18%, ctx=452451, majf=0, minf=92</span><br><span class="line">  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=100.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwt: total=524288,0,0, short=0,0,0, dropped=0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=16</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">   READ: bw=79.7MiB/s (83.6MB/s), 79.7MiB/s-79.7MiB/s (83.6MB/s-83.6MB/s), io=2048MiB (2147MB), run=25686-25686msec</span><br><span class="line"></span><br><span class="line">Disk stats (<span class="built_in">read</span>/write):</span><br><span class="line">  sda: ios=523624/5, merge=0/5, ticks=84769/1, in_queue=88, util=99.53%</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/shell/" rel="tag"># shell</a>
              <a href="/tags/nginx/" rel="tag"># nginx</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/reviews-2019/" rel="prev" title="2019 Reviews">
      <i class="fa fa-chevron-left"></i> 2019 Reviews
    </a></div>
      <div class="post-nav-item">
    <a href="/post/elk-geek/" rel="next" title="Elasticsearch(elk) technology and practice">
      Elasticsearch(elk) technology and practice <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#shell"><span class="nav-number">1.</span> <span class="nav-text">shell</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SHORTCUTS"><span class="nav-number">1.1.</span> <span class="nav-text">SHORTCUTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#find-large-file"><span class="nav-number">1.2.</span> <span class="nav-text">find large file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rename"><span class="nav-number">1.3.</span> <span class="nav-text">rename</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#network"><span class="nav-number">1.4.</span> <span class="nav-text">network</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx"><span class="nav-number">2.</span> <span class="nav-text">nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cpu-affinity"><span class="nav-number">2.1.</span> <span class="nav-text">cpu affinity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll"><span class="nav-number">2.2.</span> <span class="nav-text">epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sendfile"><span class="nav-number">2.3.</span> <span class="nav-text">sendfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gzip"><span class="nav-number">2.4.</span> <span class="nav-text">gzip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Timing-Variables"><span class="nav-number">2.5.</span> <span class="nav-text">Timing Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-cache"><span class="nav-number">2.6.</span> <span class="nav-text">nginx cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load-balance"><span class="nav-number">2.7.</span> <span class="nav-text">load balance</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dynamic-upstream"><span class="nav-number">3.</span> <span class="nav-text">dynamic upstream</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-config"><span class="nav-number">3.1.</span> <span class="nav-text">nginx config</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#curl"><span class="nav-number">4.</span> <span class="nav-text">curl</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#unixbench-amp-fio"><span class="nav-number">5.</span> <span class="nav-text">unixbench &amp; fio</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="feiyang"
      src="/images/feiy.gif">
  <p class="site-author-name" itemprop="name">feiyang</p>
  <div class="site-description" itemprop="description">南洋打工人</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/feiyang233" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;feiyang233" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:feiyang.sg@gmail.com" title="E-Mail → mailto:feiyang.sg@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.apple.com/sg/newsroom/" title="https:&#x2F;&#x2F;www.apple.com&#x2F;sg&#x2F;newsroom&#x2F;" rel="noopener" target="_blank">Apple</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://engineering.grab.com/" title="https:&#x2F;&#x2F;engineering.grab.com&#x2F;" rel="noopener" target="_blank">Grab</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wsgzao.github.io/" title="https:&#x2F;&#x2F;wsgzao.github.io&#x2F;" rel="noopener" target="_blank">奥哥</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">feiyang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://feiyang.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://feiyang233.club/post/operation-course/";
    this.page.identifier = "post/operation-course/";
    this.page.title = "Operation Course Record";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://feiyang.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
