<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"feiyang233.club","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="This blog record some useful tools for linux.">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux performance optimization">
<meta property="og:url" content="http://feiyang233.club/post/linux/index.html">
<meta property="og:site_name" content="feiyang&#39;s blog">
<meta property="og:description" content="This blog record some useful tools for linux.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225190537.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225210140.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215708.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215717.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215723.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215732.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165532.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165536.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165539.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165542.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227180106.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227180111.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232819.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232823.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232828.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232831.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228204621.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228204848.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228233800.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228234202.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183130.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183134.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183137.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183323.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229202720.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229202724.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229210141.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229210414.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091850.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091854.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091857.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091900.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231164029.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231164122.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101110429.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101112538.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101140853.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101141930.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101141933.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101141936.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101215350.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101221820.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101222832.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101222835.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101222947.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224237.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224240.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224243.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224245.png">
<meta property="article:published_time" content="2019-12-24T08:07:17.000Z">
<meta property="article:modified_time" content="2020-09-22T03:32:13.000Z">
<meta property="article:author" content="feiyang">
<meta property="article:tag" content="tools">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225190537.png">

<link rel="canonical" href="http://feiyang233.club/post/linux/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Linux performance optimization | feiyang's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">feiyang's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">费洋的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://feiyang233.club/post/linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/feiy.gif">
      <meta itemprop="name" content="feiyang">
      <meta itemprop="description" content="南洋打工人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="feiyang's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux performance optimization
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-24 16:07:17" itemprop="dateCreated datePublished" datetime="2019-12-24T16:07:17+08:00">2019-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-22 11:32:13" itemprop="dateModified" datetime="2020-09-22T11:32:13+08:00">2020-09-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/post/linux/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="post/linux/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This blog record some useful tools for linux.</p>
<span id="more"></span>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/5_90fSpp-JeD-ffZixqc9g">一文读懂Linux进程、进程组、会话、僵尸</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/QBF2ozxqy03Cprh_ugi3NA">Linux中父进程为何要苦苦地知道子进程的死亡原因？</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/2Sx52ggm_D-oFVAhmNTbHw">浅谈 Linux 高负载的系统化分析</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TQZ3anPiStzgI1B--uTGlQ">CPU 使用率低高负载的原因</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Bv1j41dZJBXy-yfVwvtJPw">Linux系统文件系统及文件基础篇</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Ilc2s4ReBiMVWQDi8aH4Tw">如何在Linux中使用awk工具详解</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/XWy_pgxOG0tspvHBDpYafg">通过10个例子掌握Linux下lsof命令</a> </li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/oGc79uYz05wDfRSivMpJUA">学习操作系统</a></li>
</ol>
<p>Linux performance tools<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225190537.png"></p>
<h1 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h1><p>What is the Linux system load ? Can refer this <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/AhZw_k5U_Pf2k9AOvruFcQ">article</a> or <a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html">this</a><br>Linux load averages are “system load averages” that show the running thread (task) demand on the system as an average number of running plus waiting threads. R + D state: Running + Uninterruptible Sleep</p>
<h2 id="stress-sysstat"><a href="#stress-sysstat" class="headerlink" title="stress sysstat"></a>stress sysstat</h2><p>We can do some test by command <code>stress</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apt install stress sysstat</span><br><span class="line"></span><br><span class="line"><span class="comment"># stress i cpu</span></span><br><span class="line">stress --cpu 1 --<span class="built_in">timeout</span> 600</span><br><span class="line"></span><br><span class="line"><span class="comment"># check uptime load</span></span><br><span class="line">watch -d <span class="built_in">uptime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check ALL cpu status</span></span><br><span class="line">mpstat -P ALL 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># check every process or thread cpu usage </span></span><br><span class="line">pidstat -u 5 1</span><br></pre></td></tr></table></figure>
<p>A thread is the basic unit of scheduling, and the process is the basic unit of resource owners</p>
<ul>
<li>Thread</li>
</ul>
<ol>
<li>smallest sequence of programming instructions that can be managed independently by a scheduler</li>
<li>Has its own register e.g. PC (program counter), SP (stack pointer)</li>
</ol>
<ul>
<li>Process</li>
</ul>
<ol>
<li>instance of a computer porgram that is being executed</li>
<li>A process can have one or multiple thread</li>
<li>Most programs are single threaded</li>
</ol>
<ul>
<li>Parallel computing</li>
</ul>
<ol>
<li>Run program currently on one or more CPUs</li>
<li>Multi-threading (shared-memory)</li>
<li>Multi-processing (independent-memory)</li>
</ol>
<h2 id="context-switch"><a href="#context-switch" class="headerlink" title="context switch"></a>context switch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interval 5s output 1 row data</span></span><br><span class="line">$ vmstat 5</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy  <span class="built_in">id</span>  wa st</span><br><span class="line"> 0  0     0 7005360  91564 818900    0    0     0     0   25   33  0  0  100  0  0</span><br><span class="line"></span><br><span class="line"><span class="comment"># cs（context switch）</span></span><br><span class="line"><span class="comment"># in（interrupt）</span></span><br><span class="line"><span class="comment"># r（Running or Runnable）</span></span><br><span class="line"><span class="comment"># b（Blocked） </span></span><br></pre></td></tr></table></figure>
<p><code>vmstat</code> only provide overall context switch of system, <code>pidstat -w</code> shows process context switch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interval 5s output 1 row data</span></span><br><span class="line">$ pidstat -w 5</span><br><span class="line">Linux 4.15.0 (ubuntu)  09/23/18  _x86_64_  (2 CPU)</span><br><span class="line"> </span><br><span class="line">08:18:26      UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">08:18:31        0         1      0.20      0.00  systemd</span><br><span class="line">08:18:31        0         8      5.40      0.00  rcu_sched</span><br><span class="line"></span><br><span class="line"><span class="comment"># cswch: voluntary context switches</span></span><br><span class="line"><span class="comment"># nvcswch: non voluntary context switches</span></span><br></pre></td></tr></table></figure>

<p>we use <code>sysbench</code> to simulate a system multi-threaded scheduling switch.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">sysbench --threads=10 --max-time=300 threads run</span><br><span class="line"></span><br><span class="line"><span class="comment"># check all context switch</span></span><br><span class="line">vmstat 1</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs     us sy <span class="built_in">id</span> wa st</span><br><span class="line"> 6  0      0 6487428 118240 1292772  0    0     0     0 9019  1398830 16 84  0  0  0</span><br><span class="line"> 8  0      0 6487428 118240 1292772  0    0     0     0 10191 1392312 16 84  0  0  0</span><br><span class="line"></span><br><span class="line"><span class="comment"># check which process cause high cs 1398830</span></span><br><span class="line"><span class="comment"># -w  Report  task switching activity  </span></span><br><span class="line"><span class="comment"># -u  Report CPU utilization.</span></span><br><span class="line">pidstat -w -u 1</span><br><span class="line">08:06:33      UID       PID    %usr %system  %guest   %<span class="built_in">wait</span>    %CPU   CPU  Command</span><br><span class="line">08:06:34        0     10488   30.00  100.00    0.00    0.00  100.00     0  sysbench</span><br><span class="line">08:06:34        0     26326    0.00    1.00    0.00    0.00    1.00     0  kworker/u4:2</span><br><span class="line"> </span><br><span class="line">08:06:33      UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">08:06:34        0         8     11.00      0.00  rcu_sched</span><br><span class="line">08:06:34        0        16      1.00      0.00  ksoftirqd/1</span><br><span class="line">08:06:34        0       471      1.00      0.00  hv_balloon</span><br><span class="line">08:06:34        0      1230      1.00      0.00  iscsid</span><br><span class="line">08:06:34        0      4089      1.00      0.00  kworker/1:5</span><br><span class="line">08:06:34        0      4333      1.00      0.00  kworker/0:3</span><br><span class="line">08:06:34        0     10499      1.00    224.00  pidstat</span><br><span class="line">08:06:34        0     26326    236.00      0.00  kworker/u4:2</span><br><span class="line">08:06:34     1000     26784    223.00      0.00  sshd</span><br><span class="line"></span><br><span class="line"><span class="comment"># -t display statistics for  threads  associated  with  selected tasks.</span></span><br><span class="line">pidstat -wt 1</span><br><span class="line"></span><br><span class="line">08:14:05      UID      TGID       TID   cswch/s nvcswch/s  Command</span><br><span class="line">...</span><br><span class="line">08:14:05        0     10551         -      6.00      0.00  sysbench</span><br><span class="line">08:14:05        0         -     10551      6.00      0.00  |__sysbench</span><br><span class="line">08:14:05        0         -     10552  18911.00 103740.00  |__sysbench</span><br><span class="line">08:14:05        0         -     10553  18915.00 100955.00  |__sysbench</span><br><span class="line">08:14:05        0         -     10554  18827.00 103954.00  |__sysbench</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># check /proc/interrupts</span></span><br><span class="line"></span><br><span class="line">watch -d <span class="built_in">cat</span> /proc/interrupts</span><br><span class="line"></span><br><span class="line">          CPU0       CPU1</span><br><span class="line">...</span><br><span class="line">RES:    2450431    5279697   Rescheduling interrupts</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="cpu-utilization"><a href="#cpu-utilization" class="headerlink" title="cpu utilization"></a>cpu utilization</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/stat | grep ^cpu</span><br><span class="line">cpu  280580 7407 286084 172900810 83602 0 583 0 0 0</span><br><span class="line">cpu0 144745 4181 176701 86423902 52076 0 301 0 0 0</span><br><span class="line">cpu1 135834 3226 109383 86476907 31525 0 282 0 0 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># perf is a good tools</span></span><br><span class="line">perf top</span><br><span class="line"></span><br><span class="line">perf record <span class="comment"># Ctrl+C stop</span></span><br><span class="line"></span><br><span class="line">perf report <span class="comment"># show record</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Best practice how to perf container process</span></span><br><span class="line"><span class="comment"># perf record in host then perf report in container</span></span><br><span class="line"><span class="comment"># install perf in host </span></span><br><span class="line">apt-get install -y linux-tools-common linux-tools-generic linux-tools-$(<span class="built_in">uname</span> -r)）</span><br><span class="line"></span><br><span class="line">perf record -g -p &lt; pid&gt;</span><br><span class="line"></span><br><span class="line">docker <span class="built_in">cp</span> perf.data <span class="built_in">test</span>:/tmp </span><br><span class="line">docker <span class="built_in">exec</span> -i -t <span class="built_in">test</span> bash</span><br><span class="line"><span class="built_in">cd</span> /tmp/ </span><br><span class="line">apt-get update &amp;&amp; apt-get install -y linux-tools linux-perf procps</span><br><span class="line">perf_4.9 report</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pstress display a tree of processes</span></span><br><span class="line">pstree | grep stress</span><br></pre></td></tr></table></figure>

<h2 id="many-Z-zombie-state"><a href="#many-Z-zombie-state" class="headerlink" title="many Z (zombie) state"></a>many Z (zombie) state</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line"></span><br><span class="line">top - 05:56:23 up 17 days, 16:45,  2 <span class="built_in">users</span>,  load average: 2.00, 1.68, 1.39</span><br><span class="line">Tasks: 247 total,   1 running,  79 sleeping,   0 stopped, 115 zombie</span><br><span class="line">%Cpu0  :  0.0 us,  0.7 sy,  0.0 ni, 38.9 <span class="built_in">id</span>, 60.5 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu1  :  0.0 us,  0.7 sy,  0.0 ni,  4.7 <span class="built_in">id</span>, 94.6 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 4340 root      20   0   44676   4048   3432 R   0.3  0.0   0:00.05 top</span><br><span class="line"> 4345 root      20   0   37280  33624    860 D   0.3  0.0   0:00.01 app</span><br><span class="line"> 4344 root      20   0   37280  33624    860 D   0.3  0.4   0:00.01 app</span><br><span class="line">    1 root      20   0  160072   9416   6752 S   0.0  0.1   0:38.59 systemd</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dstat check cpu and IO</span></span><br><span class="line">dstat 1 10</span><br><span class="line"></span><br><span class="line">You did not select any stats, using -cdngy by default.</span><br><span class="line">--total-cpu-usage-- -dsk/total- -net/total- ---paging-- ---system--</span><br><span class="line">usr sys idl wai stl| <span class="built_in">read</span>  writ| recv  send|  <span class="keyword">in</span>   out | int   csw</span><br><span class="line">  0   0  96   4   0|1219k  408k|   0     0 |   0     0 |  42   885</span><br><span class="line">  0   0   2  98   0|  34M    0 | 198B  790B|   0     0 |  42   138</span><br><span class="line">  0   0   0 100   0|  34M    0 |  66B  342B|   0     0 |  42   135</span><br><span class="line">  0   0  84  16   0|5633k    0 |  66B  342B|   0     0 |  52   177</span><br><span class="line">  0   3  39  58   0|  22M    0 |  66B  342B|   0     0 |  43   144</span><br><span class="line">  0   0   0 100   0|  34M    0 | 200B  450B|   0     0 |  46   147</span><br><span class="line">  0   0   2  98   0|  34M    0 |  66B  342B|   0     0 |  45   134</span><br><span class="line">  0   0   0 100   0|  34M    0 |  66B  342B|   0     0 |  39   131</span><br><span class="line">  0   0  83  17   0|5633k    0 |  66B  342B|   0     0 |  46   168</span><br><span class="line">  0   3  39  59   0|  22M    0 |  66B  342B|   0     0 |  37   134</span><br><span class="line"></span><br><span class="line"><span class="comment"># find the D pid</span></span><br><span class="line">top</span><br><span class="line">...</span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 4340 root      20   0   44676   4048   3432 R   0.3  0.0   0:00.05 top</span><br><span class="line"> 4345 root      20   0   37280  33624    860 D   0.3  0.0   0:00.01 app</span><br><span class="line"> 4344 root      20   0   37280  33624    860 D   0.3  0.4   0:00.01 app</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># for example pid = 4344</span></span><br><span class="line">pidstat -d -p 4344 1 3</span><br><span class="line">06:38:50      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:38:51        0      4344      0.00      0.00      0.00       0  app</span><br><span class="line">06:38:52        0      4344      0.00      0.00      0.00       0  app</span><br><span class="line">06:38:53        0      4344      0.00      0.00      0.00       0  app</span><br><span class="line"></span><br><span class="line"><span class="comment"># check all process, find 6082</span></span><br><span class="line">pidstat -d 1 20</span><br><span class="line">...</span><br><span class="line">06:48:46      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:48:47        0      4615      0.00      0.00      0.00       1  kworker/u4:1</span><br><span class="line">06:48:47        0      6080  32768.00      0.00      0.00     170  app</span><br><span class="line">06:48:47        0      6081  32768.00      0.00      0.00     184  app</span><br><span class="line"> </span><br><span class="line">06:48:47      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:48:48        0      6080      0.00      0.00      0.00     110  app</span><br><span class="line"> </span><br><span class="line">06:48:48      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:48:49        0      6081      0.00      0.00      0.00     191  app</span><br><span class="line"> </span><br><span class="line">06:48:49      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line"> </span><br><span class="line">06:48:50      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:48:51        0      6082  32768.00      0.00      0.00       0  app</span><br><span class="line">06:48:51        0      6083  32768.00      0.00      0.00       0  app</span><br><span class="line"> </span><br><span class="line">06:48:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:48:52        0      6082  32768.00      0.00      0.00     184  app</span><br><span class="line">06:48:52        0      6083  32768.00      0.00      0.00     175  app</span><br><span class="line"> </span><br><span class="line">06:48:52      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">06:48:53        0      6083      0.00      0.00      0.00     105  app</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># use strace</span></span><br><span class="line">strace -p 6082</span><br><span class="line">strace: attach: ptrace(PTRACE_SEIZE, 6082): Operation not permitted</span><br><span class="line"></span><br><span class="line">ps aux | grep 6082</span><br><span class="line">root      6082  0.0  0.0      0     0 pts/0    Z+   13:43   0:00 [app] &lt;defunct&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># find blkdev_direct_IO </span></span><br><span class="line">perf record -g</span><br><span class="line">perf report</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225210140.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find father of 3084</span></span><br><span class="line">pstree -aps 3084</span><br><span class="line">systemd,1</span><br><span class="line">  └─dockerd,15006 -H fd://</span><br><span class="line">      └─docker-containe,15024 --config /var/run/docker/containerd/containerd.toml</span><br><span class="line">          └─docker-containe,3991 -namespace moby -workdir...</span><br><span class="line">              └─app,4009</span><br><span class="line">                  └─(app,3084)</span><br></pre></td></tr></table></figure>

<h2 id="soft-interrupt"><a href="#soft-interrupt" class="headerlink" title="soft interrupt"></a>soft interrupt</h2><p>Linux divides the interrupt handling process into two phases, the upper half and the lower half: The first part is used to quickly handle interrupts. It runs in interrupt disable mode and mainly deals with hardware-related or time-sensitive tasks. The second part is used to delay processing of the unfinished work in the upper half, usually running as a kernel thread.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /proc/softirqs provides the operation of soft interrupts;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /proc/interrupts provides the operation of hard interrupts.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/softirqs</span><br><span class="line">                    CPU0       CPU1</span><br><span class="line">          HI:          0          0</span><br><span class="line">       TIMER:     811613    1972736</span><br><span class="line">      NET_TX:         49          7</span><br><span class="line">      NET_RX:    1136736    1506885</span><br><span class="line">       BLOCK:          0          0</span><br><span class="line">    IRQ_POLL:          0          0</span><br><span class="line">     TASKLET:     304787       3691</span><br><span class="line">       SCHED:     689718    1897539</span><br><span class="line">     HRTIMER:          0          0</span><br><span class="line">         RCU:    1330771    1354737</span><br><span class="line"></span><br><span class="line">ps aux | grep softirq</span><br><span class="line">root   7  0.0  0.0     0    0 ?    S    Oct10   0:01 [ksoftirqd/0]</span><br><span class="line">root  16  0.0  0.0     0    0 ?    S    Oct10   0:01 [ksoftirqd/1]</span><br><span class="line"></span><br><span class="line"><span class="comment"># sar - Collect, report, or save system activity information.</span></span><br><span class="line"></span><br><span class="line">sar -n DEV 1</span><br><span class="line">15:03:46        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</span><br><span class="line">15:03:47         eth0  12607.00   6304.00    664.86    358.11      0.00      0.00      0.00      0.01</span><br><span class="line">15:03:47      docker0   6302.00  12604.00    270.79    664.66      0.00      0.00      0.00      0.00</span><br><span class="line">15:03:47           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">15:03:47    veth9f6bbcd 6302.00  12604.00    356.95    664.66      0.00      0.00      0.00      0.05</span><br><span class="line"></span><br><span class="line"><span class="comment"># check TCP package SYN ddos attack</span></span><br><span class="line">tcpdump -i eth0 -n tcp port 80</span><br><span class="line">15:11:32.678966 IP 192.168.0.2.18238 &gt; 192.168.0.30.80: Flags [S], <span class="built_in">seq</span> 458303614, win 512, length 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215653.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215708.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215717.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215723.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191225215732.png"></p>
<h1 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h1><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165532.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165536.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165539.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227165542.png"></p>
<h2 id="buffer-amp-cache"><a href="#buffer-amp-cache" class="headerlink" title="buffer &amp; cache"></a>buffer &amp; cache</h2><p>Buffers are temporary storage of raw disk blocks, that is, used to cache data on the disk, usually not particularly large (about 20MB). In this way, the kernel can centralize scattered writes and optimize disk writes in a unified manner. For example, multiple small writes can be combined into a single large write.  </p>
<p>Cached is a page cache that reads files from disk, that is, it is used to cache data read from files. This way, the next time you access these file data, you can quickly get it directly from memory without having to access the slow disk again.  </p>
<p>SReclaimable is part of Slab. Slab consists of two parts, the recyclable part is recorded with SReclaimable; the non-recyclable part is recorded with SUnreclaim.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Before using cachestat and cachetop, we must first install the bcc package</span></span><br><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://repo.iovisor.org/apt/xenial xenial main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/iovisor.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y bcc-tools libbcc-examples linux-headers-$(<span class="built_in">uname</span> -r)</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/share/bcc/tools</span><br><span class="line"></span><br><span class="line"><span class="comment">#cachestat provides read and write hits for the entire system cache.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1s interval 3 row data</span></span><br><span class="line">cachestat 1 3</span><br><span class="line">   TOTAL   MISSES     HITS  DIRTIES   BUFFERS_MB  CACHED_MB</span><br><span class="line">    2        0        2        1           17        279</span><br><span class="line">    2        0        2        1           17        279</span><br><span class="line">    2        0        2        1           17        279 </span><br><span class="line"></span><br><span class="line"><span class="comment">#cachetop provides cache hits for each process.</span></span><br><span class="line"></span><br><span class="line">cachetop</span><br><span class="line">11:58:50 Buffers MB: 258 / Cached MB: 347 / Sort: HITS / Order: ascending</span><br><span class="line">PID      UID      CMD              HITS     MISSES   DIRTIES  READ_HIT%  WRITE_HIT%</span><br><span class="line">13029 root     python                 1        0        0     100.0%       0.0%</span><br></pre></td></tr></table></figure>
<p>Check the specify file cache, we can use <a target="_blank" rel="noopener" href="https://github.com/tobert/pcstat">pcstat</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOPATH=~/go</span><br><span class="line"><span class="built_in">export</span> PATH=~/go/bin:<span class="variable">$PATH</span></span><br><span class="line">go get golang.org/x/sys/unix</span><br><span class="line">go get github.com/tobert/pcstat/pcstat</span><br><span class="line"></span><br><span class="line"><span class="comment"># first try</span></span><br><span class="line">pcstat /bin/ls</span><br><span class="line">+---------+----------------+------------+-----------+---------+</span><br><span class="line">| Name    | Size (bytes)   | Pages      | Cached    | Percent |</span><br><span class="line">|---------+----------------+------------+-----------+---------|</span><br><span class="line">| /bin/ls | 133792         | 33         | 0         | 000.000 |</span><br><span class="line">+---------+----------------+------------+-----------+---------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># second try</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">pcstat /bin/ls</span><br><span class="line">+---------+----------------+------------+-----------+---------+</span><br><span class="line">| Name    | Size (bytes)   | Pages      | Cached    | Percent |</span><br><span class="line">|---------+----------------+------------+-----------+---------|</span><br><span class="line">| /bin/ls | 133792         | 33         | 33        | 100.000 |</span><br><span class="line">+---------+----------------+------------+-----------+---------+</span><br></pre></td></tr></table></figure>
<h2 id="memory-leak"><a href="#memory-leak" class="headerlink" title="memory leak"></a>memory leak</h2><ol>
<li><p>Check the whole memory by <code>vmstat</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vmstat 3</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line">r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line">r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">0  0    0 6601824  97620 1098784    0    0     0     0   62  322  0  0 100  0  0</span><br><span class="line">0  0    0 6601700  97620 1098788    0    0     0     0   57  251  0  0 100  0  0</span><br><span class="line">0  0    0 6601320  97620 1098788    0    0     0     3   52  306  0  0 100  0  0</span><br><span class="line">0  0    0 6601452  97628 1098788    0    0     0    27   63  326  0  0 100  0  0</span><br><span class="line">2  0    0 6601328  97628 1098788    0    0     0    44   52  299  0  0 100  0  0</span><br><span class="line">0  0    0 6601080  97628 1098792    0    0     0     0   56  285  0  0 100  0  0 </span><br></pre></td></tr></table></figure>
<p>The free column of memory is constantly changing and is in a downward trend; the buffer and cache remain basically unchanged.</p>
</li>
<li><p><code>memleak</code> is a tool in the bcc package</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/bcc/tools/memleak -a -p $(pidof app)</span><br><span class="line">WARNING: Couldn<span class="string">&#x27;t find .text section in /app</span></span><br><span class="line"><span class="string">WARNING: BCC can&#x27;</span>t handle sym look ups <span class="keyword">for</span> /app</span><br><span class="line">    addr = 7f8f704732b0 size = 8192</span><br><span class="line">    addr = 7f8f704772d0 size = 8192</span><br><span class="line">    addr = 7f8f704712a0 size = 8192</span><br><span class="line">    addr = 7f8f704752c0 size = 8192</span><br><span class="line">    32768 bytes <span class="keyword">in</span> 4 allocations from stack</span><br><span class="line">        [unknown] [app]</span><br><span class="line">        [unknown] [app]</span><br><span class="line">        start_thread+0xdb [libpthread-2.27.so] </span><br><span class="line"><span class="comment"># [unknown] is app is in docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy exec file from docker, then to check</span></span><br><span class="line">docker <span class="built_in">cp</span> app:/app /app</span><br><span class="line">/usr/share/bcc/tools/memleak -p $(pidof app) -a</span><br><span class="line">Attaching to pid 12512, Ctrl+C to quit.</span><br><span class="line">[03:00:41] Top 10 stacks with outstanding allocations:</span><br><span class="line">    addr = 7f8f70863220 size = 8192</span><br><span class="line">    addr = 7f8f70861210 size = 8192</span><br><span class="line">    addr = 7f8f7085b1e0 size = 8192</span><br><span class="line">    addr = 7f8f7085f200 size = 8192</span><br><span class="line">    addr = 7f8f7085d1f0 size = 8192</span><br><span class="line">    40960 bytes <span class="keyword">in</span> 5 allocations from stack</span><br><span class="line">        fibonacci+0x1f [app]</span><br><span class="line">        child+0x4f [app]</span><br><span class="line">        start_thread+0xdb [libpthread-2.27.so] </span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="swap"><a href="#swap" class="headerlink" title="swap"></a>swap</h2><p>Data that has been modified by the application and has not yet been written to the disk (that is, dirty pages) must be written to the disk before memory can be released.These dirty pages can generally be written to disk in two ways.</p>
<ol>
<li>You can use the system call fsync in your application to synchronize dirty pages to disk;</li>
<li>It can also be left to the system, and the kernel thread pdflush is responsible for refreshing these dirty pages.<br>Swap writes these infrequently accessed memory to disk, then releases this memory for use by other more needed processes. When the memory is accessed again, it is sufficient to re-read it from disk.<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227180106.png"><br>In the NUMA architecture, multiple processors are divided into different nodes, and each node has its own local memory space.<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227180111.png"></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">numactl --hardware</span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30</span><br><span class="line">node 0 size: 32674 MB</span><br><span class="line">node 0 free: 418 MB</span><br><span class="line">node 1 cpus: 1 3 5 7 9 11 13 15 17 19 21 23 25 27 29 31</span><br><span class="line">node 1 size: 32768 MB</span><br><span class="line">node 1 free: 212 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1 </span><br><span class="line">  0:  10  21 </span><br><span class="line">  1:  21  10 </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/zoneinfo</span><br><span class="line">...</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line"> pages free     227894</span><br><span class="line">       min      14896</span><br><span class="line">       low      18620</span><br><span class="line">       high     22344</span><br><span class="line">...</span><br><span class="line">     nr_free_pages 227894</span><br><span class="line">     nr_zone_inactive_anon 11082</span><br><span class="line">     nr_zone_active_anon 14024</span><br><span class="line">     nr_zone_inactive_file 539024</span><br><span class="line">     nr_zone_active_file 923986</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -r memory，-S  Swap </span></span><br><span class="line">$ sar -r -S 1</span><br><span class="line">04:39:56    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">04:39:57      6249676   6839824   1919632     23.50    740512     67316   1691736     10.22    815156    841868         4</span><br><span class="line"> </span><br><span class="line">04:39:56    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad</span><br><span class="line">04:39:57      8388604         0      0.00         0      0.00</span><br><span class="line"> </span><br><span class="line">04:39:57    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">04:39:58      6184472   6807064   1984836     24.30    772768     67380   1691736     10.22    847932    874224        20</span><br><span class="line"> </span><br><span class="line">04:39:57    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad</span><br><span class="line">04:39:58      8388604         0      0.00         0      0.00</span><br><span class="line"> </span><br><span class="line">…</span><br><span class="line"> </span><br><span class="line">04:44:06    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">04:44:07       152780   6525716   8016528     98.13   6530440     51316   1691736     10.22    867124   6869332         0</span><br><span class="line"> </span><br><span class="line">04:44:06    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad</span><br><span class="line">04:44:07      8384508      4096      0.05        52      1.27</span><br><span class="line"></span><br><span class="line"><span class="comment"># check cachetop 50 hit rate</span></span><br><span class="line"></span><br><span class="line">cachetop 5</span><br><span class="line">12:28:28 Buffers MB: 6349 / Cached MB: 87 / Sort: HITS / Order: ascending</span><br><span class="line">PID      UID      CMD              HITS     MISSES   DIRTIES  READ_HIT%  WRITE_HIT%</span><br><span class="line">18280   root     python              22        0        0     100.0%       0.0%</span><br><span class="line">18279   root     <span class="built_in">dd</span>              41088    41022        0      50.0%      50.0%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pages_free fluctuation</span></span><br><span class="line">watch -d grep -A 15 <span class="string">&#x27;Normal&#x27;</span> /proc/zoneinfo</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">  pages free     21328</span><br><span class="line">        min      14896</span><br><span class="line">        low      18620</span><br><span class="line">        high     22344</span><br><span class="line">        spanned  1835008</span><br><span class="line">        present  1835008</span><br><span class="line">        managed  1796710</span><br><span class="line">        protection: (0, 0, 0, 0, 0)</span><br><span class="line">      nr_free_pages 21328</span><br><span class="line">      nr_zone_inactive_anon 79776</span><br><span class="line">      nr_zone_active_anon 206854</span><br><span class="line">      nr_zone_inactive_file 918561</span><br><span class="line">      nr_zone_active_file 496695</span><br><span class="line">      nr_zone_unevictable 2251</span><br><span class="line">      nr_zone_write_pending 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sort by VmSwap</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> /proc/*/status ; <span class="keyword">do</span> awk <span class="string">&#x27;/VmSwap|Name|^Pid/&#123;printf $2 &quot; &quot; $3&#125;END&#123; print &quot;&quot;&#125;&#x27;</span> <span class="variable">$file</span>; <span class="keyword">done</span> | <span class="built_in">sort</span> -k 3 -n -r | <span class="built_in">head</span></span><br><span class="line">dockerd 2226 10728 kB</span><br><span class="line">docker-containe 2251 8516 kB</span><br><span class="line">snapd 936 4020 kB</span><br><span class="line">networkd-dispat 911 836 kB</span><br><span class="line">polkitd 1004 44 kB</span><br></pre></td></tr></table></figure>

<h2 id="summary-1"><a href="#summary-1" class="headerlink" title="summary"></a>summary</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232819.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232823.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232828.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191227232831.png"></p>
<p>What’s the difference between system and disk ?<br>A disk is a storage device (to be exact, a block device) that can be divided into different disk partitions. On a disk or disk partition, you can also create a file system and mount it in a directory on the system. In this way, the system can read and write files through this mount directory.</p>
<p>In other words, a disk is a block device that stores data and is the carrier of a file system. Therefore, the file system still needs to ensure the persistent storage of data through disk.</p>
<p>You will see this sentence in many places, everything in Linux is a file. In other words, you can access disks and files through the same file interface (such as open, read, write, close, etc.).</p>
<p>What we usually mean by “documents” is actually ordinary documents.</p>
<p>The disk or partition refers to the block device file.</p>
<h1 id="I-O"><a href="#I-O" class="headerlink" title="I-O"></a>I-O</h1><p>The Linux file system allocates two data structures for each file, an <code>index node</code> and a <code>directory entry</code>. They are mainly used to record the meta information and directory structure of files.<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228204621.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228204848.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slabtop - display kernel slab cache information in real time</span></span><br><span class="line"></span><br><span class="line">slabtop</span><br><span class="line"></span><br><span class="line">Active / Total Objects (% used)    : 503302 / 506242 (99.4%)</span><br><span class="line"> Active / Total Slabs (% used)      : 10730 / 10730 (100.0%)</span><br><span class="line"> Active / Total Caches (% used)     : 100 / 143 (69.9%)</span><br><span class="line"> Active / Total Size (% used)       : 153659.58K / 155417.98K (98.9%)</span><br><span class="line"> Minimum / Average / Maximum Object : 0.01K / 0.31K / 8.00K</span><br><span class="line"></span><br><span class="line">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span><br><span class="line">103782 103782 100%    0.19K   2471       42     19768K dentry</span><br><span class="line"> 73749  73749 100%    0.10K   1891       39      7564K buffer_head</span><br><span class="line"> 45900  45900 100%    0.13K    765       60      6120K kernfs_node_cache</span><br><span class="line"> 39985  39985 100%    0.58K    727       55     23264K inode_cache</span><br><span class="line"> 34830  34830 100%    1.05K   1161       30     37152K ext4_inode_cache</span><br><span class="line"> 18462  18462 100%    0.04K    181      102       724K ext4_extent_status</span><br><span class="line"> 17784  17784 100%    0.20K    456       39      3648K vm_area_struct</span><br><span class="line"> 15456  15456 100%    0.69K    336       46     10752K squashfs_inode_cache</span><br><span class="line"> 14336  14144   0%    0.50K    224       64      7168K kmalloc-512</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228233800.png"></p>
<h2 id="check-io"><a href="#check-io" class="headerlink" title="check io"></a>check io</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iostat -d -x 1 </span><br><span class="line">Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util </span><br><span class="line">loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br><span class="line">loop1            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br><span class="line">sda              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br><span class="line">sdb              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191228234202.png"></p>
<ul>
<li>% util is the disk I &#x2F; O usage </li>
<li>r&#x2F;s + w&#x2F;s is IOPS</li>
<li>rkB&#x2F;s + wkB&#x2F;s is the throughput</li>
<li>r_await + w_await is the response time</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check process</span></span><br><span class="line">pidstat -d 1 </span><br><span class="line">13:39:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command </span><br><span class="line">13:39:52      102       916      0.00      4.00      0.00       0  rsyslogd</span><br><span class="line"></span><br><span class="line">iotop</span><br><span class="line">Total DISK READ :       0.00 B/s | Total DISK WRITE :       7.85 K/s </span><br><span class="line">Actual DISK READ:       0.00 B/s | Actual DISK WRITE:       0.00 B/s </span><br><span class="line">  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND </span><br><span class="line">15055 be/3 root        0.00 B/s    7.85 K/s  0.00 %  0.00 % systemd-journald </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="write-issue"><a href="#write-issue" class="headerlink" title="write issue"></a>write issue</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"> top </span><br><span class="line">top - 14:43:43 up 1 day,  1:39,  2 <span class="built_in">users</span>,  load average: 2.48, 1.09, 0.63 </span><br><span class="line">Tasks: 130 total,   2 running,  74 sleeping,   0 stopped,   0 zombie </span><br><span class="line">%Cpu0  :  0.7 us,  6.0 sy,  0.0 ni,  0.7 <span class="built_in">id</span>, 92.7 wa,  0.0 hi,  0.0 si,  0.0 st </span><br><span class="line">%Cpu1  :  0.0 us,  0.3 sy,  0.0 ni, 92.3 <span class="built_in">id</span>,  7.3 wa,  0.0 hi,  0.0 si,  0.0 st </span><br><span class="line">KiB Mem :  8169308 total,   747684 free,   741336 used,  6680288 buff/cache </span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7113124 avail Mem </span><br><span class="line"> </span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND </span><br><span class="line">18940 root      20   0  656108 355740   5236 R   6.3  4.4   0:12.56 python </span><br><span class="line">1312 root      20   0  236532  24116   9648 S   0.3  0.3   9:29.80 python3 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 92.7 io_wait </span></span><br><span class="line"><span class="comment"># memroy most is used for buff/cache </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check which device</span></span><br><span class="line">iostat -x -d 1 </span><br><span class="line">Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util </span><br><span class="line">loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br><span class="line">sdb              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br><span class="line">sda              0.00   64.00      0.00  32768.00     0.00     0.00   0.00   0.00    0.00 7270.44 1102.18     0.00   512.00  15.50  99.20</span><br><span class="line"></span><br><span class="line"><span class="comment"># check which process</span></span><br><span class="line">pidstat -d 1 </span><br><span class="line"> </span><br><span class="line">15:08:35      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command </span><br><span class="line">15:08:36        0     18940      0.00  45816.00      0.00      96  python </span><br><span class="line"></span><br><span class="line">15:08:36      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command </span><br><span class="line">15:08:37        0       354      0.00      0.00      0.00     350  jbd2/sda1-8 </span><br><span class="line">15:08:37        0     18940      0.00  46000.00      0.00      96  python </span><br><span class="line">15:08:37        0     20065      0.00      0.00      0.00    1503  kworker/u4:2 </span><br><span class="line"></span><br><span class="line"><span class="comment"># check pid 18940</span></span><br><span class="line">strace -p 18940 </span><br><span class="line">strace: Process 18940 attached </span><br><span class="line">...</span><br><span class="line">mmap(NULL, 314576896, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f0f7aee9000 </span><br><span class="line">mmap(NULL, 314576896, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f0f682e8000 </span><br><span class="line">write(3, <span class="string">&quot;2018-12-05 15:23:01,709 - __main&quot;</span>..., 314572844 </span><br><span class="line">) = 314572844 </span><br><span class="line">munmap(0x7f0f682e8000, 314576896)       = 0 </span><br><span class="line">write(3, <span class="string">&quot;\n&quot;</span>, 1)                       = 1 </span><br><span class="line">munmap(0x7f0f7aee9000, 314576896)       = 0 </span><br><span class="line">close(3)                                = 0 </span><br><span class="line"><span class="built_in">stat</span>(<span class="string">&quot;/tmp/logtest.txt.1&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=943718535, ...&#125;) = 0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># check pid 18940 open files</span></span><br><span class="line">lsof -p 18940 </span><br><span class="line">COMMAND   PID USER   FD   TYPE DEVICE  SIZE/OFF    NODE NAME </span><br><span class="line">python  18940 root  cwd    DIR   0,50      4096 1549389 / </span><br><span class="line">python  18940 root  rtd    DIR   0,50      4096 1549389 / </span><br><span class="line">… </span><br><span class="line">python  18940 root    2u   CHR  136,0       0t0       3 /dev/pts/0 </span><br><span class="line">python  18940 root    3w   REG    8,1 117944320     303 /tmp/logtest.txt </span><br><span class="line"></span><br><span class="line"><span class="comment"># root cause is python wirte 300MB/s to /tmp/logtest.txt </span></span><br></pre></td></tr></table></figure>

<h2 id="io-wait-issue"><a href="#io-wait-issue" class="headerlink" title="io_wait issue"></a>io_wait issue</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">top </span><br><span class="line">top - 14:27:02 up 10:30,  1 user,  load average: 1.82, 1.26, 0.76 </span><br><span class="line">Tasks: 129 total,   1 running,  74 sleeping,   0 stopped,   0 zombie </span><br><span class="line">%Cpu0  :  3.5 us,  2.1 sy,  0.0 ni,  0.0 <span class="built_in">id</span>, 94.4 wa,  0.0 hi,  0.0 si,  0.0 st </span><br><span class="line">%Cpu1  :  2.4 us,  0.7 sy,  0.0 ni, 70.4 <span class="built_in">id</span>, 26.5 wa,  0.0 hi,  0.0 si,  0.0 st </span><br><span class="line">KiB Mem :  8169300 total,  3323248 free,   436748 used,  4409304 buff/cache </span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7412556 avail Mem </span><br><span class="line"> </span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND </span><br><span class="line">12280 root      20   0  103304  28824   7276 S  14.0  0.4   0:08.77 python </span><br><span class="line">   16 root      20   0       0      0      0 S   0.3  0.0   0:09.22 ksoftirqd/1 </span><br><span class="line">1549 root      20   0  236712  24480   9864 S   0.3  0.3   3:31.38 python3 </span><br><span class="line"></span><br><span class="line"><span class="comment"># iowait is high, memory is ok.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># util = 98%</span></span><br><span class="line">iostat -d -x 1</span><br><span class="line">Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util </span><br><span class="line">loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 </span><br><span class="line">sda              0.00   71.00      0.00  32912.00     0.00     0.00   0.00   0.00    0.00 18118.31 241.89     0.00   463.55  13.86  98.40 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># check which porcess</span></span><br><span class="line">pidstat -d 1 </span><br><span class="line">14:39:14      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command </span><br><span class="line">14:39:15        0     12280      0.00 335716.00      0.00       0  python </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">strace -p 12280 </span><br><span class="line">strace: Process 12280 attached </span><br><span class="line">select(0, NULL, NULL, NULL, &#123;tv_sec=0, tv_usec=567708&#125;) = 0 (Timeout) </span><br><span class="line"><span class="built_in">stat</span>(<span class="string">&quot;/usr/local/lib/python3.7/importlib/_bootstrap.py&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=39278, ...&#125;) = 0 </span><br><span class="line"><span class="built_in">stat</span>(<span class="string">&quot;/usr/local/lib/python3.7/importlib/_bootstrap.py&quot;</span>, &#123;st_mode=S_IFREG|0644, st_size=39278, ...&#125;) = 0 </span><br><span class="line"></span><br><span class="line"><span class="comment"># filter result</span></span><br><span class="line"> strace -p 12280 2&gt;&amp;1 | grep write </span><br><span class="line"></span><br><span class="line"><span class="comment"># introduce new tool bcc</span></span><br><span class="line"><span class="comment"># install bcc</span></span><br><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://repo.iovisor.org/apt/<span class="subst">$(lsb_release -cs)</span> <span class="subst">$(lsb_release -cs)</span> main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/iovisor.list </span><br><span class="line">sudo apt-get update </span><br><span class="line">sudo apt-get install bcc-tools libbcc-examples linux-headers-$(<span class="built_in">uname</span> -r)</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/share/bcc/tools</span><br><span class="line">./filetop -C </span><br><span class="line"> </span><br><span class="line">TID    COMM             READS  WRITES R_Kb    W_Kb    T FILE </span><br><span class="line">514    python           0      1      0       2832    R 669.txt </span><br><span class="line">514    python           0      1      0       2490    R 667.txt </span><br><span class="line">514    python           0      1      0       2685    R 671.txt </span><br><span class="line">514    python           0      1      0       2392    R 670.txt </span><br><span class="line">514    python           0      1      0       2050    R 672.txt </span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">TID    COMM             READS  WRITES R_Kb    W_Kb    T FILE </span><br><span class="line">514    python           2      0      5957    0       R 651.txt </span><br><span class="line">514    python           2      0      5371    0       R 112.txt </span><br><span class="line">514    python           2      0      4785    0       R 861.txt </span><br><span class="line">514    python           2      0      4736    0       R 213.txt </span><br><span class="line">514    python           2      0      4443    0       R 45.txt </span><br><span class="line"></span><br><span class="line"><span class="comment"># -T thread check thread 514</span></span><br><span class="line">ps -efT | grep 514</span><br><span class="line">root     12280  514 14626 33 14:47 pts/0    00:00:05 /usr/local/bin/python /app.py </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># new tool opensnoop</span></span><br><span class="line">opensnoop </span><br><span class="line">12280  python              6   0 /tmp/9046db9e-fe25-11e8-b13f-0242ac110002/650.txt </span><br><span class="line">12280  python              6   0 /tmp/9046db9e-fe25-11e8-b13f-0242ac110002/651.txt </span><br><span class="line">12280  python              6   0 /tmp/9046db9e-fe25-11e8-b13f-0242ac110002/652.txt </span><br></pre></td></tr></table></figure>

<h2 id="sql-slow"><a href="#sql-slow" class="headerlink" title="sql slow"></a>sql slow</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use top to check overview</span></span><br><span class="line">top</span><br><span class="line">top - 12:02:15 up 6 days,  8:05,  1 user,  load average: 0.66, 0.72, 0.59</span><br><span class="line">Tasks: 137 total,   1 running,  81 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  :  0.7 us,  1.3 sy,  0.0 ni, 35.9 <span class="built_in">id</span>, 62.1 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu1  :  0.3 us,  0.7 sy,  0.0 ni, 84.7 <span class="built_in">id</span>, 14.3 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  8169300 total,  7238472 free,   546132 used,   384696 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7316952 avail Mem</span><br><span class="line"> </span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">27458 999       20   0  833852  57968  13176 S   1.7  0.7   0:12.40 mysqld</span><br><span class="line">27617 root      20   0   24348   9216   4692 S   1.0  0.1   0:04.40 python</span><br><span class="line"> 1549 root      20   0  236716  24568   9864 S   0.3  0.3  51:46.57 python3</span><br><span class="line">22421 root      20   0       0      0      0 I   0.3  0.0   0:01.16 kworker/u</span><br><span class="line"></span><br><span class="line"><span class="comment"># io wait is high, so we check io</span></span><br><span class="line"></span><br><span class="line">iostat -d -x 1</span><br><span class="line">Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">...</span><br><span class="line">sda            273.00    0.00  32568.00      0.00     0.00     0.00   0.00   0.00    7.90    0.00   1.16   119.30     0.00   3.56  97.20</span><br><span class="line"></span><br><span class="line"><span class="comment"># rkB/s is 32 MB, util is 97.2%</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find the pid of high IO</span></span><br><span class="line">pidstat -d 1</span><br><span class="line">12:04:11      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">12:04:12      999     27458  32640.00      0.00      0.00       0  mysqld</span><br><span class="line">12:04:12        0     27617      4.00      4.00      0.00       3  python</span><br><span class="line">12:04:12        0     27864      0.00      4.00      0.00       0  systemd-journal</span><br><span class="line"></span><br><span class="line"><span class="comment"># next use strace+ lsof </span></span><br><span class="line">strace -f -p 27458</span><br><span class="line">[pid 28014] <span class="built_in">read</span>(38, <span class="string">&quot;934EiwT363aak7VtqF1mHGa4LL4Dhbks&quot;</span>..., 131072) = 131072</span><br><span class="line">[pid 28014] <span class="built_in">read</span>(38, <span class="string">&quot;hSs7KBDepBqA6m4ce6i6iUfFTeG9Ot9z&quot;</span>..., 20480) = 20480</span><br><span class="line">[pid 28014] <span class="built_in">read</span>(38, <span class="string">&quot;NRhRjCSsLLBjTfdqiBRLvN9K6FRfqqLm&quot;</span>..., 131072) = 131072</span><br><span class="line">[pid 28014] <span class="built_in">read</span>(38, <span class="string">&quot;AKgsik4BilLb7y6OkwQUjjqGeCTQTaRl&quot;</span>..., 24576) = 24576</span><br><span class="line">[pid 28014] <span class="built_in">read</span>(38, <span class="string">&quot;hFMHx7FzUSqfFI22fQxWCpSnDmRjamaW&quot;</span>..., 131072) = 131072</span><br><span class="line">[pid 28014] <span class="built_in">read</span>(38, <span class="string">&quot;ajUzLmKqivcDJSkiw7QWf2ETLgvQIpfC&quot;</span>..., 20480) = 20480</span><br><span class="line"></span><br><span class="line"><span class="comment"># Thread 28014 is reading a large amount of data, and the descriptor read is 38. </span></span><br><span class="line"><span class="comment"># We can execute the following lsof command and specify the thread number 28014, </span></span><br><span class="line"><span class="comment"># specifically view this suspicious thread and suspicious file:</span></span><br><span class="line">lsof -p 28014</span><br><span class="line"><span class="comment"># no output previous command </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check the previous command, failed</span></span><br><span class="line"><span class="built_in">echo</span> $?</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment">#-t thread  -a show command</span></span><br><span class="line">pstree -t -a -p 27458</span><br><span class="line">mysqld,27458 --log_bin=on --sync_binlog=1</span><br><span class="line">...</span><br><span class="line">  ├─&#123;mysqld&#125;,27922</span><br><span class="line">  ├─&#123;mysqld&#125;,27923</span><br><span class="line">  └─&#123;mysqld&#125;,28014</span><br><span class="line"></span><br><span class="line"><span class="comment"># use pid not thread id</span></span><br><span class="line">lsof -p 27458</span><br><span class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">...</span><br><span class="line">​mysqld  27458      999   38u   REG    8,1 512440000 2601895 /var/lib/mysql/test/products.MYD</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="slow-redis"><a href="#slow-redis" class="headerlink" title="slow redis"></a>slow redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line">top - 12:46:18 up 11 days,  8:49,  1 user,  load average: 1.36, 1.36, 1.04</span><br><span class="line">Tasks: 137 total,   1 running,  79 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  :  6.0 us,  2.7 sy,  0.0 ni,  5.7 <span class="built_in">id</span>, 84.7 wa,  0.0 hi,  1.0 si,  0.0 st</span><br><span class="line">%Cpu1  :  1.0 us,  3.0 sy,  0.0 ni, 94.7 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  1.3 si,  0.0 st</span><br><span class="line">KiB Mem :  8169300 total,  7342244 free,   432912 used,   394144 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7478748 avail Mem</span><br><span class="line"> </span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 9181 root      20   0  193004  27304   8716 S   8.6  0.3   0:07.15 python</span><br><span class="line"> 9085 systemd+  20   0   28352   9760   1860 D   5.0  0.1   0:04.34 redis-server</span><br><span class="line">  368 root      20   0       0      0      0 D   1.0  0.0   0:33.88 jbd2/sda1-8</span><br><span class="line">  149 root       0 -20       0      0      0 I   0.3  0.0   0:10.63 kworker/0:1H</span><br><span class="line"> 1549 root      20   0  236716  24576   9864 S   0.3  0.3  91:37.30 python3</span><br><span class="line"></span><br><span class="line"> <span class="comment"># high io wait 84.7%</span></span><br><span class="line"></span><br><span class="line">iostat -d -x 1</span><br><span class="line">Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">...</span><br><span class="line">sda              0.00  492.00      0.00   2672.00     0.00   176.00   0.00  26.35    0.00    1.76   0.00     0.00     5.43   0.00   0.00</span><br><span class="line"></span><br><span class="line"><span class="comment"># why has write operation ? redis is just read</span></span><br><span class="line">pidstat -d 1</span><br><span class="line">12:49:35      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">12:49:36        0       368      0.00     16.00      0.00      86  jbd2/sda1-8</span><br><span class="line">12:49:36      100      9085      0.00    636.00      0.00       1  redis-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># -f follow process and thread，-T system call time，-tt show time</span></span><br><span class="line">strace -f -T -tt -p 9085</span><br><span class="line">[pid  9085] 14:20:16.826131 epoll_pwait(5, [&#123;EPOLLIN, &#123;u32=8, u64=8&#125;&#125;], 10128, 65, NULL, 8) = 1 &lt;0.000055&gt;</span><br><span class="line">[pid  9085] 14:20:16.826301 <span class="built_in">read</span>(8, <span class="string">&quot;*2\r\n<span class="variable">$3</span>\r\nGET\r\n<span class="variable">$41</span>\r\nuuid:5b2e76cc-&quot;</span>..., 16384) = 61 &lt;0.000071&gt;</span><br><span class="line">[pid  9085] 14:20:16.826477 <span class="built_in">read</span>(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000063&gt;</span><br><span class="line">[pid  9085] 14:20:16.826645 write(8, <span class="string">&quot;<span class="variable">$3</span>\r\nbad\r\n&quot;</span>, 9) = 9 &lt;0.000173&gt;</span><br><span class="line">[pid  9085] 14:20:16.826907 epoll_pwait(5, [&#123;EPOLLIN, &#123;u32=8, u64=8&#125;&#125;], 10128, 65, NULL, 8) = 1 &lt;0.000032&gt;</span><br><span class="line">[pid  9085] 14:20:16.827030 <span class="built_in">read</span>(8, <span class="string">&quot;*2\r\n<span class="variable">$3</span>\r\nGET\r\n<span class="variable">$41</span>\r\nuuid:55862ada-&quot;</span>..., 16384) = 61 &lt;0.000044&gt;</span><br><span class="line">[pid  9085] 14:20:16.827149 <span class="built_in">read</span>(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000043&gt;</span><br><span class="line">[pid  9085] 14:20:16.827285 write(8, <span class="string">&quot;<span class="variable">$3</span>\r\nbad\r\n&quot;</span>, 9) = 9 &lt;0.000141&gt;</span><br><span class="line">[pid  9085] 14:20:16.827514 epoll_pwait(5, [&#123;EPOLLIN, &#123;u32=8, u64=8&#125;&#125;], 10128, 64, NULL, 8) = 1 &lt;0.000049&gt;</span><br><span class="line">[pid  9085] 14:20:16.827641 <span class="built_in">read</span>(8, <span class="string">&quot;*2\r\n<span class="variable">$3</span>\r\nGET\r\n<span class="variable">$41</span>\r\nuuid:53522908-&quot;</span>..., 16384) = 61 &lt;0.000043&gt;</span><br><span class="line">[pid  9085] 14:20:16.827784 <span class="built_in">read</span>(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000034&gt;</span><br><span class="line">[pid  9085] 14:20:16.827945 write(8, <span class="string">&quot;<span class="variable">$4</span>\r\ngood\r\n&quot;</span>, 10) = 10 &lt;0.000288&gt;</span><br><span class="line">[pid  9085] 14:20:16.828339 epoll_pwait(5, [&#123;EPOLLIN, &#123;u32=8, u64=8&#125;&#125;], 10128, 63, NULL, 8) = 1 &lt;0.000057&gt;</span><br><span class="line">[pid  9085] 14:20:16.828486 <span class="built_in">read</span>(8, <span class="string">&quot;*3\r\n<span class="variable">$4</span>\r\nSADD\r\n<span class="variable">$4</span>\r\ngood\r\n<span class="variable">$36</span>\r\n535&quot;</span>..., 16384) = 67 &lt;0.000040&gt;</span><br><span class="line">[pid  9085] 14:20:16.828623 <span class="built_in">read</span>(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000052&gt;</span><br><span class="line">[pid  9085] 14:20:16.828760 write(7, <span class="string">&quot;*3\r\n<span class="variable">$4</span>\r\nSADD\r\n<span class="variable">$4</span>\r\ngood\r\n<span class="variable">$36</span>\r\n535&quot;</span>..., 67) = 67 &lt;0.000060&gt;</span><br><span class="line">[pid  9085] 14:20:16.828970 fdatasync(7) = 0 &lt;0.005415&gt;</span><br><span class="line">[pid  9085] 14:20:16.834493 write(8, <span class="string">&quot;:1\r\n&quot;</span>, 4) = 4 &lt;0.000250&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lsof -p 9085</span><br><span class="line">redis-ser 9085 systemd-network    3r     FIFO   0,12      0t0 15447970 pipe</span><br><span class="line">redis-ser 9085 systemd-network    4w     FIFO   0,12      0t0 15447970 pipe</span><br><span class="line">redis-ser 9085 systemd-network    5u  a_inode   0,13        0    10179 [eventpoll]</span><br><span class="line">redis-ser 9085 systemd-network    6u     sock    0,9      0t0 15447972 protocol: TCP</span><br><span class="line">redis-ser 9085 systemd-network    7w      REG    8,1  8830146  2838532 /data/appendonly.aof</span><br><span class="line">redis-ser 9085 systemd-network    8u     sock    0,9      0t0 15448709 protocol: TCP</span><br><span class="line"></span><br><span class="line"><span class="comment"># Descriptor number 3 is a pipe, number 5 is an eventpoll</span></span><br><span class="line"><span class="comment"># number 7 is an ordinary file, and number 8 is a TCP socket.</span></span><br><span class="line"><span class="comment"># Only the 7th ordinary file will generate disk write, </span></span><br><span class="line"><span class="comment"># and the file path it operates on is /data/appendonly.aof. </span></span><br><span class="line"><span class="comment"># The corresponding system calls include write and fdatasync.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">strace -f -p 9085 -T -tt -e fdatasync</span><br><span class="line">strace: Process 9085 attached with 4 threads</span><br><span class="line">[pid  9085] 14:22:52.013547 fdatasync(7) = 0 &lt;0.007112&gt;</span><br><span class="line">[pid  9085] 14:22:52.022467 fdatasync(7) = 0 &lt;0.008572&gt;</span><br><span class="line">[pid  9085] 14:22:52.032223 fdatasync(7) = 0 &lt;0.006769&gt;</span><br><span class="line">...</span><br><span class="line">[pid  9085] 14:22:52.139629 fdatasync(7) = 0 &lt;0.008183&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># final check the process in docker</span></span><br><span class="line">PID=$(docker inspect --format &#123;&#123;.State.Pid&#125;&#125; app)</span><br><span class="line">nsenter --target <span class="variable">$PID</span> --net -- lsof -i</span><br><span class="line">COMMAND    PID            USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 9085 systemd-network    6u  IPv4 15447972      0t0  TCP localhost:6379 (LISTEN)</span><br><span class="line">redis-ser 9085 systemd-network    8u  IPv4 15448709      0t0  TCP localhost:6379-&gt;localhost:32996 (ESTABLISHED)</span><br><span class="line">python    9181            root    3u  IPv4 15448677      0t0  TCP *:http (LISTEN)</span><br><span class="line">python    9181            root    5u  IPv4 15449632      0t0  TCP localhost:32996-&gt;localhost:6379 (ESTABLISHED)</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<h2 id="summary-2"><a href="#summary-2" class="headerlink" title="summary"></a>summary</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183130.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183134.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183137.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229183323.png"></p>
<h1 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h1><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229202720.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229202724.png"></p>
<ul>
<li>Bandwidth, which indicates the maximum transmission rate of the link. The unit is usually b&#x2F;s (bits per second).</li>
<li>Throughput, which indicates the amount of data successfully transmitted per unit of time. The unit is usually b&#x2F;s (bits&#x2F;second) or B&#x2F;s (bytes&#x2F;second). Throughput is limited by bandwidth, and throughput&#x2F;bandwidth is the utilization of the network.</li>
<li>Delay means the delay from the time the network request is sent until the remote response is received.</li>
<li>PPS is the abbreviation of Packet Per Second (packet per second), which means the transmission rate in network packets.</li>
</ul>
<h2 id="basic-command"><a href="#basic-command" class="headerlink" title="basic command"></a>basic command</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ifconfig </span></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.17.3  netmask 255.255.255.0  broadcast 192.168.17.255</span><br><span class="line">        inet6 fe80::20c:29ff:fe35:6403  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:0c:29:35:64:03  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 2193  bytes 150818 (150.8 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 203  bytes 24234 (24.2 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 17791  bytes 1264539 (1.2 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 17791  bytes 1264539 (1.2 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<ul>
<li>errors indicates the number of packets with errors, such as check errors, frame synchronization errors, etc.</li>
<li>dropped indicates the number of dropped packets, that is, the packet has received the Ring Buffer, but the packet was lost due to insufficient memory and other reasons;</li>
<li>overruns indicates the number of overrun packets, that is, the network I &#x2F; O speed is too fast, causing the packets in the Ring Buffer to be too late to be processed (the queue is full) and the packet loss;</li>
<li>carrier indicates the number of packets with carrirer errors, such as mismatch in duplex mode, problems with physical cables, etc .;</li>
<li>collisions indicates the number of collision packets.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/feiyang<span class="comment"># netstat -nlp | head -n 3</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      549/systemd-resolve </span><br><span class="line"></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ss -lntp | head -n 3</span></span><br><span class="line">State    Recv-Q    Send-Q        Local Address:Port        Peer Address:Port                                                                                    </span><br><span class="line">LISTEN   0         128           127.0.0.53%lo:53               0.0.0.0:*        <span class="built_in">users</span>:((&quot;systemd-resolve&quot;,pid=<span class="number">549</span>,fd=<span class="number">13</span>))                                      </span><br><span class="line">LISTEN   0         128                 0.0.0.0:22               0.0.0.0:*        <span class="built_in">users</span>:((&quot;sshd&quot;,pid=<span class="number">1040</span>,fd=<span class="number">3</span>)) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>When the socket is connected (Established),<br>Recv-Q indicates the number of bytes (that is, the length of the receive queue) that the socket buffer has not been taken away by the application.<br>Send-Q indicates the number of bytes (that is, the length of the send queue) that have not been acknowledged by the remote host.</p>
</li>
<li><p>When the socket is in the listening state (Listening),<br>Recv-Q represents the current value of the syn backlog.<br>Send-Q represents the largest syn backlog value.</p>
</li>
</ul>
<p>The syn backlog is the length of the semi-connected queue in the TCP protocol stack, and accordingly there is also a fully connected queue (accept queue)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat</span></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># netstat -s</span></span><br><span class="line">Ip:</span><br><span class="line">    Forwarding: 2</span><br><span class="line">    19787 total packets received</span><br><span class="line">    0 forwarded</span><br><span class="line">    0 incoming packets discarded</span><br><span class="line">    19785 incoming packets delivered</span><br><span class="line">    19373 requests sent out</span><br><span class="line">Icmp:</span><br><span class="line">    0 ICMP messages received</span><br><span class="line">    0 input ICMP message failed</span><br><span class="line">    ICMP input histogram:</span><br><span class="line">    0 ICMP messages sent</span><br><span class="line">    0 ICMP messages failed</span><br><span class="line">    ICMP output histogram:</span><br><span class="line">Tcp:</span><br><span class="line">    4 active connection openings</span><br><span class="line">    1 passive connection openings</span><br><span class="line">    4 failed connection attempts</span><br><span class="line">    0 connection resets received</span><br><span class="line">    1 connections established</span><br><span class="line">    294 segments received</span><br><span class="line">    195 segments sent out</span><br><span class="line">    0 segments retransmitted</span><br><span class="line">    0 bad segments received</span><br><span class="line">    4 resets sent</span><br><span class="line">Udp:</span><br><span class="line">    19388 packets received</span><br><span class="line">    0 packets to unknown port received</span><br><span class="line">    0 packet receive errors</span><br><span class="line">    19180 packets sent</span><br><span class="line">    0 receive buffer errors</span><br><span class="line">    0 send buffer errors</span><br><span class="line">    IgnoredMulti: 107</span><br><span class="line">UdpLite:</span><br><span class="line">TcpExt:</span><br><span class="line">    3 delayed acks sent</span><br><span class="line">    47 packet headers predicted</span><br><span class="line">    2 acknowledgments not containing data payload received</span><br><span class="line">    170 predicted acknowledgments</span><br><span class="line">    TCPBacklogCoalesce: 9</span><br><span class="line">    TCPAutoCorking: 12</span><br><span class="line">    TCPOrigDataSent: 180</span><br><span class="line">    TCPDelivered: 180</span><br><span class="line">IpExt:</span><br><span class="line">    InMcastPkts: 279</span><br><span class="line">    OutMcastPkts: 66</span><br><span class="line">    InBcastPkts: 107</span><br><span class="line">    OutBcastPkts: 7</span><br><span class="line">    InOctets: 1405727</span><br><span class="line">    OutOctets: 1393405</span><br><span class="line">    InMcastOctets: 19672</span><br><span class="line">    OutMcastOctets: 6290</span><br><span class="line">    InBcastOctets: 9737</span><br><span class="line">    OutBcastOctets: 327</span><br><span class="line">    InNoECTPkts: 19788</span><br><span class="line"></span><br><span class="line"><span class="comment"># ss</span></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ss -s</span></span><br><span class="line">Total: 958 (kernel 2224)</span><br><span class="line">TCP:   6 (estab 1, closed 0, orphaned 0, synrecv 0, timewait 0/0), ports 0</span><br><span class="line"></span><br><span class="line">Transport  Total     IP        IPv6</span><br><span class="line">*	         2224      -         -        </span><br><span class="line">RAW	       0         0         0        </span><br><span class="line">UDP	       6         4         2        </span><br><span class="line">TCP	       6         4         2        </span><br><span class="line">INET	     12        8         4        </span><br><span class="line">FRAG	     0         0         0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sar</span></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># sar -n DEV 1</span></span><br><span class="line">Linux 5.0.0-37-generic (ubuntu) 	12/29/2019 	_x86_64_	(2 CPU)</span><br><span class="line"></span><br><span class="line">08:42:20 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</span><br><span class="line">08:42:21 PM     ens33      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">08:42:21 PM        lo     80.00     80.00      5.55      5.55      0.00      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line">08:42:21 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</span><br><span class="line">08:42:22 PM     ens33     34.00     34.00      1.99      3.25      0.00      0.00      0.00      0.00</span><br><span class="line">08:42:22 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line"><span class="comment"># ping</span></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ping -c3 114.114.114.114</span></span><br><span class="line">PING 114.114.114.114 (114.114.114.114) 56(84) bytes of data.</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=1 ttl=128 time=222 ms</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=2 ttl=128 time=221 ms</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=3 ttl=128 time=222 ms</span><br><span class="line"></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ethtool ens33 | grep Speed</span></span><br><span class="line">	Speed: 1000Mb/s</span><br></pre></td></tr></table></figure>
<h2 id="C10K-and-C1000K"><a href="#C10K-and-C1000K" class="headerlink" title="C10K and C1000K"></a>C10K and C1000K</h2><ol>
<li><p>select or poll Apache</p>
</li>
<li><p>epoll Nginx </p>
</li>
<li><p>Asynchronous I&#x2F;O</p>
</li>
<li><p>one master, multiple worker</p>
</li>
<li><p>multi-process listen same port, need enable SO_REUSEPORT</p>
</li>
<li><p>C1000K’s solution is essentially built on epoll’s non-blocking I &#x2F; O model.</p>
</li>
<li><p>C10M: To solve this problem, the most important thing is to skip the lengthy path of the kernel protocol stack and send the network packets directly to the application to be processed. There are two common mechanisms here, DPDK and XDP.</p>
</li>
</ol>
<ul>
<li>DPDK is the standard for user mode networks. It skips the kernel protocol stack and directly processes the network reception by the user mode process through polling.<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229210141.png">  </li>
<li>XDP (eXpress Data Path) is a high-performance network data path provided by the Linux kernel. It allows network packets to be processed before entering the kernel protocol stack, which can also bring higher performance. The bottom layer of XDP, like the bcc-tools we used before, is implemented based on the eBPF mechanism of the Linux kernel.<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191229210414.png"></li>
</ul>
<h2 id="performance-test"><a href="#performance-test" class="headerlink" title="performance test"></a>performance test</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># enable pktgen</span></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># modprobe pktgen</span></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ps -ef | grep pktgen | grep -v grep</span></span><br><span class="line">root       2478      2  0 22:25 ?        00:00:00 [kpktgend_0]</span><br><span class="line">root       2480      2  0 22:25 ?        00:00:00 [kpktgend_1]</span><br><span class="line">root       2481      2  0 22:25 ?        00:00:00 [kpktgend_0]</span><br><span class="line">root       2482      2  0 22:25 ?        00:00:00 [kpktgend_1]</span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># ls /proc/net/pktgen/</span></span><br><span class="line">kpktgend_0  kpktgend_1  pgctrl</span><br></pre></td></tr></table></figure>
<p>do some test</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># define function</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">pgset</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> result</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$1</span> &gt; <span class="variable">$PGDEV</span></span><br><span class="line"> </span><br><span class="line">    result=`<span class="built_in">cat</span> <span class="variable">$PGDEV</span> | fgrep <span class="string">&quot;Result: OK:&quot;</span>`</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$result</span>&quot;</span> = <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">cat</span> <span class="variable">$PGDEV</span> | fgrep Result:</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># bind 0 thread to eth0</span></span><br><span class="line">PGDEV=/proc/net/pktgen/kpktgend_0</span><br><span class="line">pgset <span class="string">&quot;rem_device_all&quot;</span>   <span class="comment"># clear bind</span></span><br><span class="line">pgset <span class="string">&quot;add_device eth0&quot;</span>  <span class="comment"># add eth0 </span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># config eth0 </span></span><br><span class="line">PGDEV=/proc/net/pktgen/eth0</span><br><span class="line">pgset <span class="string">&quot;count 1000000&quot;</span>    <span class="comment"># total send package</span></span><br><span class="line">pgset <span class="string">&quot;delay 5000&quot;</span>       <span class="comment"># interval </span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span>      <span class="comment"># SKB package duplicate</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 64&quot;</span>      <span class="comment"># package size</span></span><br><span class="line">pgset <span class="string">&quot;dst 192.168.0.30&quot;</span> <span class="comment"># dest IP</span></span><br><span class="line">pgset <span class="string">&quot;dst_mac 11:11:11:11:11:11&quot;</span>  <span class="comment"># dest MAC</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># start test</span></span><br><span class="line">PGDEV=/proc/net/pktgen/pgctrl</span><br><span class="line">pgset <span class="string">&quot;start&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/net/pktgen/eth0</span><br><span class="line">Params: count 1000000  min_pkt_size: 64  max_pkt_size: 64</span><br><span class="line">     frags: 0  delay: 0  clone_skb: 0  ifname: eth0</span><br><span class="line">     flows: 0 flowlen: 0</span><br><span class="line">...</span><br><span class="line">Current:</span><br><span class="line">     pkts-sofar: 1000000  errors: 0</span><br><span class="line">     started: 1534853256071us  stopped: 1534861576098us idle: 70673us</span><br><span class="line">...</span><br><span class="line">Result: OK: 8320027(c8249354+d70673) usec, 1000000 (64byte,0frags)</span><br><span class="line">  120191pps 61Mb/sec (61537792bps) errors: 0</span><br></pre></td></tr></table></figure>
<p>TCP test</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">apt-get install iperf3</span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">yum install iperf3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@ubuntu:/home/feiyang<span class="comment"># iperf3 -s -i 1 -p 10000</span></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Server listening on 10000</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iperf3 -c 192.168.0.30 -b 1G -t 15 -P 2 -p 10000</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">...</span><br><span class="line">[SUM]   0.00-15.04  sec  0.00 Bytes  0.00 bits/sec                  sender</span><br><span class="line">[SUM]   0.00-15.04  sec  1.51 GBytes   860 Mbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>HTTP test</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Ubuntu</span><br><span class="line">apt-get install -y apache2-utils</span><br><span class="line"># CentOS</span><br><span class="line">yum install -y httpd-tools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ab -c 1000 -n 10000 http://192.168.0.30/</span><br><span class="line">...</span><br><span class="line">Server Software:        nginx/1.15.8</span><br><span class="line">Server Hostname:        192.168.0.30</span><br><span class="line">Server Port:            80</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">Requests per second:    1078.54 [#/sec] (mean)</span><br><span class="line">Time per request:       927.183 [ms] (mean)</span><br><span class="line">Time per request:       0.927 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          890.00 [Kbytes/sec] received</span><br><span class="line"> </span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0   27 152.1      1    1038</span><br><span class="line">Processing:     9  207 843.0     22    9242</span><br><span class="line">Waiting:        8  207 843.0     22    9242</span><br><span class="line">Total:         15  233 857.7     23    9268</span><br><span class="line"> </span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%     23</span><br><span class="line">  66%     24</span><br><span class="line">  75%     24</span><br><span class="line">  80%     26</span><br><span class="line">  90%    274</span><br><span class="line">  95%   1195</span><br><span class="line">  98%   2335</span><br><span class="line">  99%   4663</span><br><span class="line"> 100%   9268 (longest request)</span><br></pre></td></tr></table></figure>
<p>App test</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/wg/wrk</span><br><span class="line"><span class="built_in">cd</span> wrk</span><br><span class="line">apt-get install build-essential -y</span><br><span class="line">make</span><br><span class="line">sudo <span class="built_in">cp</span> wrk /usr/local/bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wrk -c 1000 -t 2 http://192.168.0.30/</span><br><span class="line">Running 10s <span class="built_in">test</span> @ http://192.168.0.30/</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    65.83ms  174.06ms   1.99s    95.85%</span><br><span class="line">    Req/Sec     4.87k   628.73     6.78k    69.00%</span><br><span class="line">  96954 requests <span class="keyword">in</span> 10.06s, 78.59MB <span class="built_in">read</span></span><br><span class="line">  Socket errors: connect 0, <span class="built_in">read</span> 0, write 0, <span class="built_in">timeout</span> 179</span><br><span class="line">Requests/sec:   9641.31</span><br><span class="line">Transfer/sec:      7.82MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># setup add parameter</span></span><br><span class="line">-- example script that demonstrates response handling and</span><br><span class="line">-- retrieving an authentication token to <span class="built_in">set</span> on all future</span><br><span class="line">-- requests</span><br><span class="line"> </span><br><span class="line">token = nil</span><br><span class="line">path  = <span class="string">&quot;/authenticate&quot;</span></span><br><span class="line"> </span><br><span class="line">request = <span class="keyword">function</span>()</span><br><span class="line">   <span class="built_in">return</span> wrk.format(<span class="string">&quot;GET&quot;</span>, path)</span><br><span class="line">end</span><br><span class="line"> </span><br><span class="line">response = <span class="keyword">function</span>(status, headers, body)</span><br><span class="line">   <span class="keyword">if</span> not token and status == 200 <span class="keyword">then</span></span><br><span class="line">      token = headers[<span class="string">&quot;X-Token&quot;</span>]</span><br><span class="line">      path  = <span class="string">&quot;/resource&quot;</span></span><br><span class="line">      wrk.headers[<span class="string">&quot;X-Token&quot;</span>] = token</span><br><span class="line">   end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">wrk -c 1000 -t 2 -s auth.lua http://192.168.0.30/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="DNS-slow"><a href="#DNS-slow" class="headerlink" title="DNS slow"></a>DNS slow</h2><ul>
<li>A record, used to translate the domain name into an IP address;</li>
<li>CNAME record for creating aliases;</li>
<li>The NS record indicates the name server address corresponding to the domain name.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/feiyang/wrk<span class="comment"># dig +trace +nodnssec feiyang233.club</span></span><br><span class="line">root@ubuntu:/home/feiyang/wrk<span class="comment"># nslookup feiyang233.club</span></span><br><span class="line">Server:		1.1.1.1</span><br><span class="line">Address:	1.1.1.1<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">feiyang233.club	canonical name = fainyang.github.io.</span><br><span class="line">Name:	fainyang.github.io</span><br><span class="line">Address: 185.199.109.153</span><br><span class="line">Name:	fainyang.github.io</span><br><span class="line">Address: 185.199.110.153</span><br><span class="line">Name:	fainyang.github.io</span><br><span class="line">Address: 185.199.111.153</span><br><span class="line">Name:	fainyang.github.io</span><br><span class="line">Address: 185.199.108.153</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@ubuntu:/home/feiyang/wrk<span class="comment"># dig +trace +nodnssec feiyang233.club</span></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.11-Ubuntu &lt;&lt;&gt;&gt; +trace +nodnssec feiyang233.club</span><br><span class="line">;; global options: +cmd</span><br><span class="line">.			7974	IN	NS	i.root-servers.net.</span><br><span class="line">.			7974	IN	NS	j.root-servers.net.</span><br><span class="line">.			7974	IN	NS	k.root-servers.net.</span><br><span class="line">.			7974	IN	NS	l.root-servers.net.</span><br><span class="line">.			7974	IN	NS	m.root-servers.net.</span><br><span class="line">.			7974	IN	NS	a.root-servers.net.</span><br><span class="line">.			7974	IN	NS	b.root-servers.net.</span><br><span class="line">.			7974	IN	NS	c.root-servers.net.</span><br><span class="line">.			7974	IN	NS	d.root-servers.net.</span><br><span class="line">.			7974	IN	NS	e.root-servers.net.</span><br><span class="line">.			7974	IN	NS	f.root-servers.net.</span><br><span class="line">.			7974	IN	NS	g.root-servers.net.</span><br><span class="line">.			7974	IN	NS	h.root-servers.net.</span><br><span class="line">;; Received 431 bytes from 1.1.1.1<span class="comment">#53(1.1.1.1) in 8 ms</span></span><br><span class="line"></span><br><span class="line">club.			172800	IN	NS	ns4.dns.nic.club.</span><br><span class="line">club.			172800	IN	NS	ns1.dns.nic.club.</span><br><span class="line">club.			172800	IN	NS	ns6.dns.nic.club.</span><br><span class="line">club.			172800	IN	NS	ns2.dns.nic.club.</span><br><span class="line">club.			172800	IN	NS	ns3.dns.nic.club.</span><br><span class="line">club.			172800	IN	NS	ns5.dns.nic.club.</span><br><span class="line">;; Received 456 bytes from 192.36.148.17<span class="comment">#53(i.root-servers.net) in 104 ms</span></span><br><span class="line"></span><br><span class="line">feiyang233.club.	3600	IN	NS	f1g1ns1.dnspod.net.</span><br><span class="line">feiyang233.club.	3600	IN	NS	f1g1ns2.dnspod.net.</span><br><span class="line">;; Received 98 bytes from 156.154.144.215<span class="comment">#53(ns1.dns.nic.club) in 189 ms</span></span><br><span class="line"></span><br><span class="line">;; Received 44 bytes from 182.140.167.166<span class="comment">#53(f1g1ns1.dnspod.net) in 404 ms</span></span><br></pre></td></tr></table></figure>
<ol>
<li>no &#x2F;etc&#x2F;resolv.conf <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nslookup feiyang233.club</span><br><span class="line">;; connection timed out; no servers could be reached</span><br><span class="line"></span><br><span class="line"><span class="comment"># add DNS</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 1.1.1.1&quot;</span> &gt; /etc/resolv.conf</span><br></pre></td></tr></table></figure></li>
<li>DNS unstable<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">time nslookup time.geekbang.org</span><br><span class="line">Server:		8.8.8.8</span><br><span class="line">Address:	8.8.8.8<span class="comment">#53</span></span><br><span class="line"> </span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:	time.geekbang.org</span><br><span class="line">Address: 39.106.233.176</span><br><span class="line"> </span><br><span class="line">real	0m10.349s</span><br><span class="line">user	0m0.004s</span><br><span class="line">sys	0m0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">time nslookup time.geekbang.org</span><br><span class="line">;; connection timed out; no servers could be reached</span><br><span class="line"> </span><br><span class="line">real	0m15.011s</span><br><span class="line">user	0m0.006s</span><br><span class="line">sys	0m0.006s</span><br></pre></td></tr></table></figure>
The DNS server itself has problems, the response is slow and unstable;</li>
</ol>
<p>The network delay from the client to the DNS server is relatively large;</p>
<p>DNS request or response packets are lost by network devices on the link in some cases.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ping -c3 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=0 ttl=31 time=137.637 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=31 time=144.743 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=31 time=138.576 ms</span><br><span class="line">--- 8.8.8.8 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 137.637/140.319/144.743/3.152 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># try other DNS</span></span><br><span class="line"></span><br><span class="line">ping -c3 114.114.114.114</span><br><span class="line">PING 114.114.114.114 (114.114.114.114): 56 data bytes</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=0 ttl=67 time=31.130 ms</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=1 ttl=56 time=31.302 ms</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=2 ttl=56 time=31.250 ms</span><br><span class="line">--- 114.114.114.114 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 31.130/31.227/31.302/0.072 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> nameserver 114.114.114.114 &gt; /etc/resolv.conf</span><br><span class="line">time nslookup time.geekbang.org</span><br><span class="line">Server:		114.114.114.114</span><br><span class="line">Address:	114.114.114.114<span class="comment">#53</span></span><br><span class="line"> </span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:	time.geekbang.org</span><br><span class="line">Address: 39.106.233.176</span><br><span class="line"> </span><br><span class="line">real    0m0.064s</span><br><span class="line">user    0m0.007s</span><br><span class="line">sys     0m0.006s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="dump-traffic"><a href="#dump-traffic" class="headerlink" title="dump traffic"></a>dump traffic</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">apt-get install tcpdump wireshark</span><br><span class="line"> </span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">yum install -y tcpdump wireshark</span><br><span class="line"></span><br><span class="line">tcpdump -nn udp port 53 or host 35.190.27.188</span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">14:02:31.100564 IP 172.16.3.4.56669 &gt; 114.114.114.114.53: 36909+ A? geektime.org. (30)</span><br><span class="line">14:02:31.507699 IP 114.114.114.114.53 &gt; 172.16.3.4.56669: 36909 1/0/0 A 35.190.27.188 (46)</span><br><span class="line">14:02:31.508164 IP 172.16.3.4 &gt; 35.190.27.188: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 4356, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">14:02:31.539667 IP 35.190.27.188 &gt; 172.16.3.4: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 4356, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">14:02:31.539995 IP 172.16.3.4.60254 &gt; 114.114.114.114.53: 49932+ PTR? 188.27.190.35.in-addr.arpa. (44)</span><br><span class="line">14:02:36.545104 IP 172.16.3.4.60254 &gt; 114.114.114.114.53: 49932+ PTR? 188.27.190.35.in-addr.arpa. (44)</span><br><span class="line">14:02:41.551284 IP 172.16.3.4 &gt; 35.190.27.188: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 4356, <span class="built_in">seq</span> 2, length 64</span><br><span class="line">14:02:41.582363 IP 35.190.27.188 &gt; 172.16.3.4: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 4356, <span class="built_in">seq</span> 2, length 64</span><br><span class="line">14:02:42.552506 IP 172.16.3.4 &gt; 35.190.27.188: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 4356, <span class="built_in">seq</span> 3, length 64</span><br><span class="line">14:02:42.583646 IP 35.190.27.188 &gt; 172.16.3.4: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 4356, <span class="built_in">seq</span> 3, length 64</span><br></pre></td></tr></table></figure>
<p>The purpose of PTR reverse address resolution is to find out the domain name from the IP address, but in fact, not all IP addresses will define PTR records, so PTR queries are likely to fail.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check PTR</span></span><br><span class="line"></span><br><span class="line">nslookup -<span class="built_in">type</span>=PTR 35.190.27.188 8.8.8.8</span><br><span class="line">Server:	8.8.8.8</span><br><span class="line">Address:	8.8.8.8<span class="comment">#53</span></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">188.27.190.35.in-addr.arpa	name = 188.27.190.35.bc.googleusercontent.com.</span><br><span class="line">Authoritative answers can be found from:</span><br><span class="line"></span><br><span class="line"><span class="comment"># test</span></span><br><span class="line">dig +short example.com</span><br><span class="line">93.184.216.34</span><br><span class="line">tcpdump -nn host 93.184.216.34 -w web.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># in another tty</span></span><br><span class="line">curl http://example.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091850.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091854.png">  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#tcpdump output format</span></span><br><span class="line">Timestamp Protocol Source Address Source Port&gt; Destination Address Destination Port Network Packet Details</span><br><span class="line">时间戳 协议 源地址 源端口 &gt; 目的地址 目的端口 网络包详细信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091857.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231091900.png"></p>
<h2 id="anti-DDoS"><a href="#anti-DDoS" class="headerlink" title="anti-DDoS"></a>anti-DDoS</h2><p>DDoS（Distributed Denial of Service） </p>
<ul>
<li>Running out of bandwidth</li>
<li>Running out of operating system resources</li>
<li>Running out of application resources</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -S set TCP  SYN，-p port 80</span></span><br><span class="line"><span class="comment"># -i u10  10us interval</span></span><br><span class="line">hping3 -S -p 80 -i u10 192.168.0.30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -w only output HTTP status total time -o redirect to /dev/null</span></span><br><span class="line">curl -s -w <span class="string">&#x27;Http code: %&#123;http_code&#125;\nTotal time:%&#123;time_total&#125;s\n&#x27;</span> -o /dev/null http://192.168.0.30/</span><br><span class="line">...</span><br><span class="line">Http code: 200</span><br><span class="line">Total time:0.002s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sar -n DEV 1</span><br><span class="line">08:55:49        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</span><br><span class="line">08:55:50      docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">08:55:50         eth0  22274.00    629.00   1174.64     37.78      0.00      0.00      0.00      0.02</span><br><span class="line">08:55:50           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line"></span><br><span class="line"><span class="comment"># small package 54B （1174*1024/22274=54）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -i eth0 nic，-n Don&#x27;t convert addresses (i.e., host addresses, port numbers, etc.) to names.</span></span><br><span class="line"><span class="comment"># tcp port 80 </span></span><br><span class="line">$ tcpdump -i eth0 -n tcp port 80</span><br><span class="line">09:15:48.287047 IP 192.168.0.2.27095 &gt; 192.168.0.30: Flags [S], <span class="built_in">seq</span> 1288268370, win 512, length 0</span><br><span class="line">09:15:48.287050 IP 192.168.0.2.27131 &gt; 192.168.0.30: Flags [S], <span class="built_in">seq</span> 2084255254, win 512, length 0</span><br><span class="line">09:15:48.287052 IP 192.168.0.2.27116 &gt; 192.168.0.30: Flags [S], <span class="built_in">seq</span> 677393791, win 512, length 0</span><br><span class="line">09:15:48.287055 IP 192.168.0.2.27141 &gt; 192.168.0.30: Flags [S], <span class="built_in">seq</span> 1276451587, win 512, length 0</span><br><span class="line">09:15:48.287068 IP 192.168.0.2.27154 &gt; 192.168.0.30: Flags [S], <span class="built_in">seq</span> 1851495339, win 512, length 0</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231164029.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20191231164122.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check SYN_REC</span></span><br><span class="line">netstat -n -p | grep SYN_REC</span><br><span class="line">tcp        0      0 192.168.0.30:80          192.168.0.2:12503      SYN_RECV    -</span><br><span class="line">tcp        0      0 192.168.0.30:80          192.168.0.2:13502      SYN_RECV    -</span><br><span class="line">tcp        0      0 192.168.0.30:80          192.168.0.2:15256      SYN_RECV    -</span><br><span class="line">tcp        0      0 192.168.0.30:80          192.168.0.2:18117      SYN_RECV    -</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">netstat -n -p | grep SYN_REC | <span class="built_in">wc</span> -l</span><br><span class="line">193</span><br><span class="line"></span><br><span class="line"><span class="comment"># method for SYN DDoS</span></span><br><span class="line"><span class="comment"># limit SYN 1/s</span></span><br><span class="line">$ iptables -A INPUT -p tcp --syn -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s -j ACCEPT</span><br><span class="line"> </span><br><span class="line"><span class="comment"># limit every IP only establish 10 connections during 60s</span></span><br><span class="line">$ iptables -I INPUT -p tcp --dport 80 --syn -m recent --name SYN_FLOOD --update --seconds 60 --hitcount 10 -j REJECT</span><br><span class="line"></span><br><span class="line">sysctl net.ipv4.tcp_max_syn_backlog</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># increase max</span></span><br><span class="line">sysctl -w net.ipv4.tcp_max_syn_backlog=1024</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># decrease retry time from default 5 to 1</span></span><br><span class="line">sysctl -w net.ipv4.tcp_synack_retries=1</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable TCP SYN Cookies</span></span><br><span class="line">sysctl -w net.ipv4.tcp_syncookies=1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># above set is temporary, for persistent</span></span><br><span class="line"><span class="built_in">cat</span> /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 1024</span><br></pre></td></tr></table></figure>
<p>In a Linux server, you can increase the anti-attack capability of the server and reduce the impact of DDoS on normal services through various methods such as kernel tuning, DPDK, and XDP. In the application, you can use various levels of caching, WAF, CDN and other methods to mitigate the impact of DDoS on the application.</p>
<h2 id="network-slow"><a href="#network-slow" class="headerlink" title="network slow"></a>network slow</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">traceroute --tcp -p 80 -n baidu.com</span><br><span class="line">traceroute to baidu.com (123.125.115.110), 30 hops max, 60 byte packets</span><br><span class="line"> 1  * * *</span><br><span class="line"> 2  * * *</span><br><span class="line"> 3  * * *</span><br><span class="line"> 4  * * *</span><br><span class="line"> 5  * * *</span><br><span class="line"> 6  * * *</span><br><span class="line"> 7  * * *</span><br><span class="line"> 8  * * *</span><br><span class="line"> 9  * * *</span><br><span class="line">10  * * *</span><br><span class="line">11  * * *</span><br><span class="line">12  * * *</span><br><span class="line">13  * * *</span><br><span class="line">14  123.125.115.110  20.684 ms *  20.798 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># install wrk</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/wg/wrk</span><br><span class="line"><span class="built_in">cd</span> wrk</span><br><span class="line">apt-get install build-essential -y</span><br><span class="line">make</span><br><span class="line">sudo <span class="built_in">cp</span> wrk /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># create 2 nginx</span></span><br><span class="line">docker run --network=host --name=good -itd nginx</span><br><span class="line"></span><br><span class="line">docker run --name nginx --network=host -itd feisky/nginx:latency</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl port 80 and 8080</span></span><br><span class="line"><span class="comment"># 80 ok</span></span><br><span class="line">curl http://192.168.0.30</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">...</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 8080 ok</span></span><br><span class="line">curl http://192.168.0.30:8080</span><br><span class="line">...</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 80 ok </span></span><br><span class="line">hping3 -c 3 -S -p 80 192.168.0.30</span><br><span class="line">HPING 192.168.0.30 (eth0 192.168.0.30): S <span class="built_in">set</span>, 40 headers + 0 data bytes</span><br><span class="line">len=44 ip=192.168.0.30 ttl=64 DF <span class="built_in">id</span>=0 sport=80 flags=SA <span class="built_in">seq</span>=0 win=29200 rtt=7.8 ms</span><br><span class="line">len=44 ip=192.168.0.30 ttl=64 DF <span class="built_in">id</span>=0 sport=80 flags=SA <span class="built_in">seq</span>=1 win=29200 rtt=7.7 ms</span><br><span class="line">len=44 ip=192.168.0.30 ttl=64 DF <span class="built_in">id</span>=0 sport=80 flags=SA <span class="built_in">seq</span>=2 win=29200 rtt=7.6 ms</span><br><span class="line"> </span><br><span class="line">--- 192.168.0.30 hping statistic ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 7.6/7.7/7.8 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8080 ok</span></span><br><span class="line">hping3 -c 3 -S -p 8080 192.168.0.30</span><br><span class="line">HPING 192.168.0.30 (eth0 192.168.0.30): S <span class="built_in">set</span>, 40 headers + 0 data bytes</span><br><span class="line">len=44 ip=192.168.0.30 ttl=64 DF <span class="built_in">id</span>=0 sport=8080 flags=SA <span class="built_in">seq</span>=0 win=29200 rtt=7.7 ms</span><br><span class="line">len=44 ip=192.168.0.30 ttl=64 DF <span class="built_in">id</span>=0 sport=8080 flags=SA <span class="built_in">seq</span>=1 win=29200 rtt=7.6 ms</span><br><span class="line">len=44 ip=192.168.0.30 ttl=64 DF <span class="built_in">id</span>=0 sport=8080 flags=SA <span class="built_in">seq</span>=2 win=29200 rtt=7.3 ms</span><br><span class="line"> </span><br><span class="line">--- 192.168.0.30 hping statistic ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 7.3/7.6/7.7 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># test 80 </span></span><br><span class="line">测试 80 端口性能</span><br><span class="line">$ <span class="comment"># wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30/</span></span><br><span class="line">Running 10s <span class="built_in">test</span> @ http://192.168.0.30/</span><br><span class="line">  2 threads and 100 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     9.19ms   12.32ms 319.61ms   97.80%</span><br><span class="line">    Req/Sec     6.20k   426.80     8.25k    85.50%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    7.78ms</span><br><span class="line">     75%    8.22ms</span><br><span class="line">     90%    9.14ms</span><br><span class="line">     99%   50.53ms</span><br><span class="line">  123558 requests <span class="keyword">in</span> 10.01s, 100.15MB <span class="built_in">read</span></span><br><span class="line">Requests/sec:  12340.91</span><br><span class="line">Transfer/sec:     10.00MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># test 8080, this nginx is very slow</span></span><br><span class="line">wrk --latency -c 100 -t 2 --<span class="built_in">timeout</span> 2 http://192.168.0.30:8080/</span><br><span class="line">Running 10s <span class="built_in">test</span> @ http://192.168.0.30:8080/</span><br><span class="line">  2 threads and 100 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    43.60ms    6.41ms  56.58ms   97.06%</span><br><span class="line">    Req/Sec     1.15k   120.29     1.92k    88.50%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   44.02ms</span><br><span class="line">     75%   44.33ms</span><br><span class="line">     90%   47.62ms</span><br><span class="line">     99%   48.88ms</span><br><span class="line">  22853 requests <span class="keyword">in</span> 10.01s, 18.55MB <span class="built_in">read</span></span><br><span class="line">Requests/sec:   2283.31</span><br><span class="line">Transfer/sec:      1.85MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># dump the traffic</span></span><br><span class="line"></span><br><span class="line">tcpdump -nn tcp port 8080 -w nginx.pcap</span><br><span class="line">wrk --latency -c 100 -t 2 --<span class="built_in">timeout</span> 2 http://192.168.0.30:8080/</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Open this nginx.pcap in Wireshark, Statics -&gt; Flow Graph，select “Limit to display filter” and setup Flow type to “TCP Flows”：<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101110429.png"><br>Blue area is very slow costs 40ms, 40ms is minimum timeout for TCP delayed acknowledgement (Delayed ACK).<br>An optimization mechanism for TCP ACK, that is, instead of sending an ACK for each request, you wait for a while (such as 40ms). If there are other packets that need to be sent during this period, send them with the ACK. Of course, if you can’t wait for other packets, then send ACK separately after timeout.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP_QUICKACK (since Linux 2.4.4)</span></span><br><span class="line"><span class="comment"># Enable  quickack mode if set or disable quickack mode if cleared.  In quickack mode, </span></span><br><span class="line"><span class="comment"># acks are sent imme‐diately, rather than delayed if needed in accordance to normal TCP operation.</span></span><br><span class="line"><span class="comment"># This flag is  not  perma‐nent,  it only enables a switch to or from quickack mode.  </span></span><br><span class="line"><span class="comment"># Subsequent operation of the TCP protocol will once again enter/leave quickack mode</span></span><br><span class="line"><span class="comment"># depending on internal  protocol  processing  and  factors  such  as delayed ack timeouts occurring </span></span><br><span class="line"><span class="comment"># and data transfer.  This option should not be used in code intended to be portable.</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Nagle%27s_algorithm">The Nagle algorithm</a> is an optimization algorithm used in the TCP protocol to reduce the number of small packets sent, in order to improve the utilization of the actual bandwidth. The Nagle algorithm specifies that there can be at most one unconfirmed outstanding packet on a TCP connection; no other packets are sent until an ACK for this packet is received.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#TCP_NODELAY</span></span><br><span class="line"><span class="comment"># If set, disable the Nagle algorithm.  This means that segments are always sent as soon as possible,</span></span><br><span class="line"><span class="comment"># even if there is only a small amount of data.  When not set, data is buffered until there is a </span></span><br><span class="line"><span class="comment"># sufficient amount to send out, thereby avoiding the frequent sending of small packets, </span></span><br><span class="line"><span class="comment"># which results in poor uti‐lization of the network.  </span></span><br><span class="line"><span class="comment"># This option is overridden by TCP_CORK; however, setting this option forces an explicit flush of</span></span><br><span class="line"><span class="comment"># pending output, even if TCP_CORK is currently set.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check tcp_nodelay</span></span><br><span class="line"><span class="built_in">cat</span> /etc/nginx/nginx.conf | grep tcp_nodelay</span><br><span class="line">    tcp_nodelay    off;</span><br></pre></td></tr></table></figure>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p>Network Address and Port Translation<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101112538.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SNAT</span></span><br><span class="line"><span class="comment"># MASQUERADE, change out ip to Linux wan ip</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -j MASQUERADE</span><br><span class="line"></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.2 -j SNAT --to-source 100.100.100.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># DNAT</span></span><br><span class="line">iptables -t nat -A PREROUTING -d 100.100.100.100 -j DNAT --to-destination 192.168.0.2</span><br><span class="line"></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.2 -j SNAT --to-source 100.100.100.100</span><br><span class="line">iptables -t nat -A PREROUTING -d 100.100.100.100 -j DNAT --to-destination 192.168.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable forward function</span></span><br><span class="line"><span class="comment"># sysctl net.ipv4.ip_forward</span></span><br><span class="line"><span class="comment"># net.ipv4.ip_forward = 1</span></span><br><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># open files</span></span><br><span class="line"><span class="built_in">ulimit</span> -n</span><br><span class="line">1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># increase to 66535</span></span><br><span class="line"><span class="built_in">ulimit</span> -n 65536</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ab -c 5000 -n 100000 -r -s 2 http://192.168.0.30/</span><br><span class="line">...</span><br><span class="line">Requests per second:    6576.21 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       760.317 [ms] (mean)</span><br><span class="line">Time per request:       0.152 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          5390.19 [Kbytes/sec] received</span><br><span class="line"> </span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0  177 714.3      9    7338</span><br><span class="line">Processing:     0   27  39.8     19     961</span><br><span class="line">Waiting:        0   23  39.5     16     951</span><br><span class="line">Total:          1  204 716.3     28    7349</span><br><span class="line"></span><br><span class="line"><span class="comment"># run new test container</span></span><br><span class="line">docker run --name nginx --privileged -p 8080:8080 -itd feisky/nginx:nat</span><br><span class="line"></span><br><span class="line">iptables -nL -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">DOCKER     all  --  0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">RETURN     all  --  0.0.0.0/0            0.0.0.0/0</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.17.0.2:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># test again</span></span><br><span class="line">ab -c 5000 -n 100000 -r -s 2 http://192.168.0.30:8080/</span><br><span class="line">...</span><br><span class="line">apr_pollset_poll: The <span class="built_in">timeout</span> specified has expired (70007)</span><br><span class="line">Total of 5602 requests completed</span><br><span class="line"></span><br><span class="line"><span class="comment"># set timeout is 30s</span></span><br><span class="line">ab -c 5000 -n 10000 -r -s 30 http://192.168.0.30:8080/</span><br><span class="line">...</span><br><span class="line">Requests per second:    76.47 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       65380.868 [ms] (mean)</span><br><span class="line">Time per request:       13.076 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          44.79 [Kbytes/sec] received</span><br><span class="line"> </span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0 1300 5578.0      1   65184</span><br><span class="line">Processing:     0 37916 59283.2      1  130682</span><br><span class="line">Waiting:        0    2   8.7      1     414</span><br><span class="line">Total:          1 39216 58711.6   1021  130682</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>we create a script to follow this iptable path</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env stap</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment"># Dropwatch.stp</span></span><br><span class="line"><span class="comment"># Author: Neil Horman &lt;nhorman@redhat.com&gt;</span></span><br><span class="line"><span class="comment"># An example script to mimic the behavior of the dropwatch utility</span></span><br><span class="line"><span class="comment"># http://fedorahosted.org/dropwatch</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Array to hold the list of drop points we find</span></span><br><span class="line">global locations</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Note when we turn the monitor on and off</span></span><br><span class="line">probe begin &#123; <span class="built_in">printf</span>(<span class="string">&quot;Monitoring for dropped packets\n&quot;</span>) &#125;</span><br><span class="line">probe end &#123; <span class="built_in">printf</span>(<span class="string">&quot;Stopping dropped packet monitor\n&quot;</span>) &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># increment a drop counter for every location we drop at</span></span><br><span class="line">probe kernel.trace(<span class="string">&quot;kfree_skb&quot;</span>) &#123; locations[<span class="variable">$location</span>] &lt;&lt;&lt; <span class="string">1 &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"># Every 5 seconds report our drop locations</span></span><br><span class="line"><span class="string">probe timer.sec(5)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  printf(&quot;\n&quot;)</span></span><br><span class="line"><span class="string">  foreach (l in locations-) &#123;</span></span><br><span class="line"><span class="string">    printf(&quot;%d packets dropped at %s\n&quot;,</span></span><br><span class="line"><span class="string">           @count(locations[l]), symname(l))</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  delete locations</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>run this script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">stap --all-modules dropwatch.stp</span><br><span class="line">Monitoring <span class="keyword">for</span> dropped packets</span><br><span class="line"></span><br><span class="line">10031 packets dropped at nf_hook_slow</span><br><span class="line">676 packets dropped at tcp_v4_rcv</span><br><span class="line"> </span><br><span class="line">7284 packets dropped at nf_hook_slow</span><br><span class="line">268 packets dropped at tcp_v4_rcv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># use perf to check </span></span><br><span class="line"><span class="comment"># record 30s crtl + c</span></span><br><span class="line">$ perf record -a -g -- <span class="built_in">sleep</span> 30</span><br><span class="line"> </span><br><span class="line"><span class="comment"># print report</span></span><br><span class="line">$ perf report -g graph,0</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101140853.png"></p>
<p>Slow in 3 point</p>
<ol>
<li>ipv4_conntrack_in</li>
<li>br_nf_pre_routing</li>
<li>iptable_nat_ipv4_in</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check conntrack</span></span><br><span class="line">sysctl -a | grep conntrack</span><br><span class="line">net.netfilter.nf_conntrack_count = 180</span><br><span class="line">net.netfilter.nf_conntrack_max = 1000</span><br><span class="line">net.netfilter.nf_conntrack_buckets = 65536</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># net.netfilter.nf_conntrack_max = 1000 is to small</span></span><br><span class="line">dmesg | <span class="built_in">tail</span></span><br><span class="line">[104235.156774] nf_conntrack: nf_conntrack: table full, dropping packet</span><br><span class="line">[104243.800401] net_ratelimit: 3939 callbacks suppressed</span><br><span class="line">[104243.800401] nf_conntrack: nf_conntrack: table full, dropping packet</span><br><span class="line">[104262.962157] nf_conntrack: nf_conntrack: table full, dropping packet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The connection tracking object size is 376, and the list item size is 16</span><br><span class="line">nf_conntrack_max * connection tracking object size + nf_conntrack_buckets * list item size</span><br><span class="line">= 1000 * 376 + 65536 * 16 B</span><br><span class="line">= 1.4 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># increase conntrack</span></span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_max=131072</span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_buckets=65536</span><br><span class="line"></span><br><span class="line"><span class="comment"># test again, now delay is ok</span></span><br><span class="line">ab -c 5000 -n 100000 -r -s 2 http://192.168.0.30:8080/</span><br><span class="line">...</span><br><span class="line">Requests per second:    6315.99 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       791.641 [ms] (mean)</span><br><span class="line">Time per request:       0.158 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          4985.15 [Kbytes/sec] received</span><br><span class="line"> </span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0  355 793.7     29    7352</span><br><span class="line">Processing:     8  311 855.9     51   14481</span><br><span class="line">Waiting:        0  292 851.5     36   14481</span><br><span class="line">Total:         15  666 1216.3    148   14645</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conntrack -L -o extended | <span class="built_in">head</span></span><br><span class="line">ipv4     2 tcp      6 7 TIME_WAIT src=192.168.0.2 dst=192.168.0.96 sport=51744 dport=8080 src=172.17.0.2 dst=192.168.0.2 sport=8080 dport=51744 [ASSURED] mark=0 use=1</span><br><span class="line">ipv4     2 tcp      6 6 TIME_WAIT src=192.168.0.2 dst=192.168.0.96 sport=51524 dport=8080 src=172.17.0.2 dst=192.168.0.2 sport=8080 dport=51524 [ASSURED] mark=0 use=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conntrack -L -o extended | <span class="built_in">wc</span> -l</span><br><span class="line">14289</span><br><span class="line"></span><br><span class="line"><span class="comment"># collecte all states</span></span><br><span class="line">conntrack -L -o extended | awk <span class="string">&#x27;/^.*tcp.*$/ &#123;sum[$6]++&#125; END &#123;for(i in sum) print i, sum[i]&#125;&#x27;</span></span><br><span class="line">SYN_RECV 4</span><br><span class="line">CLOSE_WAIT 9</span><br><span class="line">ESTABLISHED 2877</span><br><span class="line">FIN_WAIT 3</span><br><span class="line">SYN_SENT 2113</span><br><span class="line">TIME_WAIT 9283</span><br><span class="line"></span><br><span class="line"><span class="comment"># collect each source IP</span></span><br><span class="line">conntrack -L -o extended | awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&quot;=&quot;</span> -f 2 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -n 10</span><br><span class="line">  14116 192.168.0.2</span><br><span class="line">    172 192.168.0.96</span><br></pre></td></tr></table></figure>
<h2 id="important"><a href="#important" class="headerlink" title="important"></a>important</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcp time_wait settings check </span></span><br><span class="line">sysctl net.netfilter.nf_conntrack_tcp_timeout_time_wait</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</span><br></pre></td></tr></table></figure>
<h2 id="summary-3"><a href="#summary-3" class="headerlink" title="summary"></a>summary</h2><p>After setting TCP_NODELAY for the TCP connection, you can disable the Nagle algorithm;</p>
<p>After TCP_CORK is enabled for a TCP connection, small packets can be aggregated into large packets before being sent (note that it will block the sending of small packets);</p>
<p>With SO_SNDBUF and SO_RCVBUF, you can adjust the size of the socket send buffer and receive buffer, respectively.<br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101141930.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101141933.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101141936.png"><br>The three values of tcp_rmem and tcp_wmem are min, default, and max respectively. The system will automatically adjust the size of the TCP receive &#x2F; send buffer according to these settings.</p>
<p>The three values of udp_mem are min, pressure, max. The system will automatically adjust the size of the UDP send buffer according to these settings.</p>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101215350.png"></p>
<h1 id="Best-Practice"><a href="#Best-Practice" class="headerlink" title="Best Practice"></a>Best Practice</h1><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check running  docker</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># check logs</span></span><br><span class="line">docker logs -f [container_id]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># check container config in json format</span></span><br><span class="line">docker inspect [container_id] -f <span class="string">&#x27;&#123;&#123;json .State&#125;&#125;&#x27;</span> | jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;exited&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Running&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;Pid&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;ExitCode&quot;</span>: 137,</span><br><span class="line">  <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># OMM Kill, we can check in host</span></span><br><span class="line">dmesg</span><br><span class="line">[193038.106393] java invoked oom-killer: gfp_mask=0x14000c0(GFP_KERNEL), nodemask=(null), order=0, oom_score_adj=0</span><br><span class="line">[193038.106396] java cpuset=0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53 mems_allowed=0</span><br><span class="line">[193038.106402] CPU: 0 PID: 27424 Comm: java Tainted: G  OE    4.15.0-1037 <span class="comment">#39-Ubuntu</span></span><br><span class="line">[193038.106404] Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090007  06/02/2017</span><br><span class="line">[193038.106405] Call Trace:</span><br><span class="line">[193038.106414]  dump_stack+0x63/0x89</span><br><span class="line">[193038.106419]  dump_header+0x71/0x285</span><br><span class="line">[193038.106422]  oom_kill_process+0x220/0x440</span><br><span class="line">[193038.106424]  out_of_memory+0x2d1/0x4f0</span><br><span class="line">[193038.106429]  mem_cgroup_out_of_memory+0x4b/0x80</span><br><span class="line">[193038.106432]  mem_cgroup_oom_synchronize+0x2e8/0x320</span><br><span class="line">[193038.106435]  ? mem_cgroup_css_online+0x40/0x40</span><br><span class="line">[193038.106437]  pagefault_out_of_memory+0x36/0x7b</span><br><span class="line">[193038.106443]  mm_fault_error+0x90/0x180</span><br><span class="line">[193038.106445]  __do_page_fault+0x4a5/0x4d0</span><br><span class="line">[193038.106448]  do_page_fault+0x2e/0xe0</span><br><span class="line">[193038.106454]  ? page_fault+0x2f/0x50</span><br><span class="line">[193038.106456]  page_fault+0x45/0x50</span><br><span class="line">[193038.106459] RIP: 0033:0x7fa053e5a20d</span><br><span class="line">[193038.106460] RSP: 002b:00007fa0060159e8 EFLAGS: 00010206</span><br><span class="line">[193038.106462] RAX: 0000000000000000 RBX: 00007fa04c4b3000 RCX: 0000000009187440</span><br><span class="line">[193038.106463] RDX: 00000000943aa440 RSI: 0000000000000000 RDI: 000000009b223000</span><br><span class="line">[193038.106464] RBP: 00007fa006015a60 R08: 0000000002000002 R09: 00007fa053d0a8a1</span><br><span class="line">[193038.106465] R10: 00007fa04c018b80 R11: 0000000000000206 R12: 0000000100000768</span><br><span class="line">[193038.106466] R13: 00007fa04c4b3000 R14: 0000000100000768 R15: 0000000010000000</span><br><span class="line">[193038.106468] Task <span class="keyword">in</span> /docker/0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53</span><br><span class="line">killed as a result of <span class="built_in">limit</span> of /docker/</span><br><span class="line">0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53</span><br><span class="line">[193038.106478] memory: usage 524288kB, <span class="built_in">limit</span> 524288kB, failcnt 77</span><br><span class="line">[193038.106480] memory+swap: usage 0kB, <span class="built_in">limit</span> 9007199254740988kB, failcnt 0</span><br><span class="line">[193038.106481] kmem: usage 3708kB, <span class="built_in">limit</span> 9007199254740988kB, failcnt 0</span><br><span class="line">[193038.106481] Memory cgroup stats <span class="keyword">for</span> /docker/0f2b3fcdd2578165ea77266cdc7b1ad43e75877b0ac1889ecda30a78cb78bd53: cache:0KB rss:520580KB rss_huge:450560KB shmem:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:0KB active_anon:520580KB inactive_file:0KB active_file:0KB unevictable:0KB</span><br><span class="line">[193038.106494] [ pid ]   uid  tgid total_vm      rss pgtables_bytes swapents oom_score_adj name</span><br><span class="line">[193038.106571] [27281]     0 27281  1153302   134371  1466368        0             0 java</span><br><span class="line">[193038.106574] Memory cgroup out of memory: Kill process 27281 (java) score 1027 or sacrifice child</span><br><span class="line">[193038.148334] Killed process 27281 (java) total-vm:4613208kB, anon-rss:517316kB, file-rss:20168kB, shmem-rss:0kB</span><br><span class="line">[193039.607503] oom_reaper: reaped process 27281 (java), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># add memory limit</span></span><br><span class="line">docker run --name tomcat --cpus 0.1 -m 512M -p 8080:8080 -itd feisky/tomcat:8</span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> tomcat java -XX:+PrintFlagsFinal -version | grep HeapSize</span><br><span class="line">uintx ErgoHeapSizeLimit                         = 0                                   &#123;product&#125;</span><br><span class="line">uintx HeapSizePerGCThread                       = 87241520                            &#123;product&#125;</span><br><span class="line">uintx InitialHeapSize                          := 132120576                           &#123;product&#125;</span><br><span class="line">uintx LargePageHeapSizeThreshold                = 134217728                           &#123;product&#125;</span><br><span class="line">uintx MaxHeapSize                              := 2092957696   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># set env to limit memory</span></span><br><span class="line">docker run --name tomcat --cpus 0.1 -m 512M -e JAVA_OPTS=<span class="string">&#x27;-Xmx512m -Xms512m&#x27;</span> -p 8080:8080 -itd feisky/tomcat:8</span><br><span class="line"></span><br><span class="line"><span class="comment"># check thread </span></span><br><span class="line">PID=$(docker inspect [container_id] -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span>)</span><br><span class="line"><span class="comment"># run pidstat</span></span><br><span class="line">$ pidstat -t -p <span class="variable">$PID</span> 1</span><br><span class="line">12:59:28      UID      TGID       TID    %usr %system  %guest   %<span class="built_in">wait</span>    %CPU   CPU  Command</span><br><span class="line">12:59:29        0     29850         -   10.00    0.00    0.00    0.00   10.00     0  java</span><br><span class="line">12:59:29        0         -     29850    0.00    0.00    0.00    0.00    0.00     0  |__java</span><br><span class="line">12:59:29        0         -     29897    5.00    1.00    0.00   86.00    6.00     1  |__java</span><br><span class="line">...</span><br><span class="line">12:59:29        0         -     29905    3.00    0.00    0.00   97.00    3.00     0  |__java</span><br><span class="line">12:59:29        0         -     29906    2.00    0.00    0.00   49.00    2.00     1  |__java</span><br><span class="line">12:59:29        0         -     29908    0.00    0.00    0.00   45.00    0.00     0  |__java</span><br><span class="line"></span><br><span class="line"><span class="comment"># io_wait is high</span></span><br></pre></td></tr></table></figure>
<h2 id="packet-loss"><a href="#packet-loss" class="headerlink" title="packet loss"></a>packet loss</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check max connection</span></span><br><span class="line">sysctl net.netfilter.nf_conntrack_max</span><br><span class="line">net.netfilter.nf_conntrack_max = 262144</span><br><span class="line"></span><br><span class="line">sysctl net.netfilter.nf_conntrack_count</span><br><span class="line">net.netfilter.nf_conntrack_count = 182</span><br><span class="line"></span><br><span class="line"><span class="comment"># execute in container</span></span><br><span class="line">root@nginx:/ iptables -t filter -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 25 packets, 1000 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">    6   240 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.29999999981</span><br><span class="line"> </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line"> </span><br><span class="line">Chain OUTPUT (policy ACCEPT 15 packets, 660 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">    6   264 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.29999999981</span><br><span class="line"></span><br><span class="line"><span class="comment"># check MTU</span></span><br><span class="line">netstat -i</span><br><span class="line">Kernel Interface table</span><br><span class="line">Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span><br><span class="line">eth0       100      157      0    344 0            94      0      0      0 BMRU</span><br><span class="line">lo       65536        0      0      0 0             0      0      0      0 LRU</span><br></pre></td></tr></table></figure>
<p>During Linux startup, there are three special processes, that is, the three processes with the smallest PID numbers.</p>
<p>Process 0 is an idle process. This is also the first process created by the system. After initializing processes 1 and 2, it becomes an idle task. It runs when no other tasks are executing on the CPU.</p>
<p>Process 1 is the init process, which is usually the systemd process. It runs in user mode and is used to manage other user mode processes.</p>
<p>Process 2 is a kthreadd process, which runs in kernel mode and is used to manage kernel threads.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ps -f --ppid 2 -p 2</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          2      0  0 12:02 ?        00:00:01 [kthreadd]</span><br><span class="line">root          9      2  0 12:02 ?        00:00:21 [ksoftirqd/0]</span><br><span class="line">root         10      2  0 12:02 ?        00:11:47 [rcu_sched]</span><br><span class="line">root         11      2  0 12:02 ?        00:00:18 [migration/0]</span><br><span class="line">...</span><br><span class="line">root      11094      2  0 14:20 ?        00:00:00 [kworker/1:0-eve]</span><br><span class="line">root      11647      2  0 14:27 ?        00:00:00 [kworker/0:2-cgr]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel thread names (CMD) are in square brackets []</span></span><br><span class="line">ps -ef | grep <span class="string">&quot;\[.*\]&quot;</span></span><br><span class="line">root         2     0  0 08:14 ?        00:00:00 [kthreadd]</span><br><span class="line">root         3     2  0 08:14 ?        00:00:00 [rcu_gp]</span><br><span class="line">root         4     2  0 08:14 ?        00:00:00 [rcu_par_gp]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># test -S: SYN  -p port, -i interval 10us</span></span><br><span class="line">hping3 -S -p 80 -i u10 192.168.0.30</span><br><span class="line"></span><br><span class="line"><span class="comment"># top</span></span><br><span class="line">top</span><br><span class="line">top - 08:31:43 up 17 min,  1 user,  load average: 0.00, 0.00, 0.02</span><br><span class="line">Tasks: 128 total,   1 running,  69 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  :  0.3 us,  0.3 sy,  0.0 ni, 66.8 <span class="built_in">id</span>,  0.3 wa,  0.0 hi, 32.4 si,  0.0 st</span><br><span class="line">%Cpu1  :  0.0 us,  0.3 sy,  0.0 ni, 65.2 <span class="built_in">id</span>,  0.0 wa,  0.0 hi, 34.5 si,  0.0 st</span><br><span class="line">KiB Mem :  8167040 total,  7234236 free,   358976 used,   573828 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7560460 avail Mem</span><br><span class="line"> </span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">    9 root      20   0       0      0      0 S   7.0  0.0   0:00.48 ksoftirqd/0</span><br><span class="line">   18 root      20   0       0      0      0 S   6.9  0.0   0:00.56 ksoftirqd/1</span><br><span class="line"> 2489 root      20   0  876896  38408  21520 S   0.3  0.5   0:01.50 docker-containe</span><br><span class="line"> 3008 root      20   0   44536   3936   3304 R   0.3  0.0   0:00.09 top</span><br><span class="line">    1 root      20   0   78116   9000   6432 S   0.0  0.1   0:11.77 systemd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># check ksoftirqd pid is 9</span></span><br><span class="line">pstack 9</span><br><span class="line">Could not attach to target 9: Operation not permitted.</span><br><span class="line">detach: No such process</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/9/stack</span><br><span class="line">[&lt;0&gt;] smpboot_thread_fn+0x166/0x170</span><br><span class="line">[&lt;0&gt;] kthread+0x121/0x140</span><br><span class="line">[&lt;0&gt;] ret_from_fork+0x35/0x40</span><br><span class="line">[&lt;0&gt;] 0xffffffffffffffff</span><br><span class="line"></span><br><span class="line"><span class="comment"># perf </span></span><br><span class="line">perf record -a -g -p 9 -- <span class="built_in">sleep</span> 30</span><br><span class="line">perf report</span><br><span class="line"></span><br><span class="line"><span class="comment"># install flamegraph</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph</span><br><span class="line"><span class="built_in">cd</span> FlameGraph</span><br><span class="line"></span><br><span class="line">perf script -i /root/perf.data | ./stackcollapse-perf.pl --all |  ./flamegraph.pl &gt; ksoftirqd.svg</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Dynamic-Tracing"><a href="#Dynamic-Tracing" class="headerlink" title="Dynamic Tracing"></a>Dynamic Tracing</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/kernel/debug/tracing</span><br><span class="line"></span><br><span class="line"><span class="comment"># if not exist this directory</span></span><br><span class="line">mount -t debugfs nodev /sys/kernel/debug</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> available_tracers</span><br><span class="line">hwlat blk mmiotrace function_graph wakeup_dl wakeup_rt wakeup <span class="keyword">function</span> nop</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> available_filter_functions</span><br><span class="line"><span class="built_in">cat</span> available_events</span><br><span class="line"></span><br><span class="line"><span class="comment"># test</span></span><br><span class="line"><span class="built_in">echo</span> do_sys_open &gt; set_graph_function</span><br><span class="line"><span class="built_in">echo</span> function_graph &gt; current_tracer</span><br><span class="line"><span class="built_in">echo</span> funcgraph-proc &gt; trace_options</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable trace</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; tracing_on</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># disable trace</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; tracing_on</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> trace</span><br><span class="line"><span class="comment"># tracer: function_graph</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CPU  TASK/PID         DURATION                  FUNCTION CALLS</span></span><br><span class="line"><span class="comment"># |     |    |           |   |                     |   |   |   |</span></span><br><span class="line"> 0)    ls-12276    |               |  <span class="function"><span class="title">do_sys_open</span></span>() &#123;</span><br><span class="line"> 0)    ls-12276    |               |    <span class="function"><span class="title">getname</span></span>() &#123;</span><br><span class="line"> 0)    ls-12276    |               |      <span class="function"><span class="title">getname_flags</span></span>() &#123;</span><br><span class="line"> 0)    ls-12276    |               |        <span class="function"><span class="title">kmem_cache_alloc</span></span>() &#123;</span><br><span class="line"> 0)    ls-12276    |               |          <span class="function"><span class="title">_cond_resched</span></span>() &#123;</span><br><span class="line"> 0)    ls-12276    |   0.049 us    |            rcu_all_qs();</span><br><span class="line"> 0)    ls-12276    |   0.791 us    |          &#125;</span><br><span class="line"> 0)    ls-12276    |   0.041 us    |          should_failslab();</span><br><span class="line"> 0)    ls-12276    |   0.040 us    |          prefetch_freepointer();</span><br><span class="line"> 0)    ls-12276    |   0.039 us    |          memcg_kmem_put_cache();</span><br><span class="line"> 0)    ls-12276    |   2.895 us    |        &#125;</span><br><span class="line"> 0)    ls-12276    |               |        <span class="function"><span class="title">__check_object_size</span></span>() &#123;</span><br><span class="line"> 0)    ls-12276    |   0.067 us    |          __virt_addr_valid();</span><br><span class="line"> 0)    ls-12276    |   0.044 us    |          __check_heap_object();</span><br><span class="line"> 0)    ls-12276    |   0.039 us    |          check_stack_object();</span><br><span class="line"> 0)    ls-12276    |   1.570 us    |        &#125;</span><br><span class="line"> 0)    ls-12276    |   5.790 us    |      &#125;</span><br><span class="line"> 0)    ls-12276    |   6.325 us    |    &#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">apt-get install trace-cmd</span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">yum install trace-cmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># above 5 step simplify to follow 1 step</span></span><br><span class="line">trace-cmd record -p function_graph -g do_sys_open -O funcgraph-proc <span class="built_in">ls</span></span><br><span class="line">$ trace-cmd report</span><br><span class="line">...</span><br><span class="line">  ls-12418 [000] 85558.075341: funcgraph_entry:                   |  <span class="function"><span class="title">do_sys_open</span></span>() &#123;</span><br><span class="line">  ls-12418 [000] 85558.075363: funcgraph_entry:                   |    <span class="function"><span class="title">getname</span></span>() &#123;</span><br><span class="line">  ls-12418 [000] 85558.075364: funcgraph_entry:                   |      <span class="function"><span class="title">getname_flags</span></span>() &#123;</span><br><span class="line">  ls-12418 [000] 85558.075364: funcgraph_entry:                   |        <span class="function"><span class="title">kmem_cache_alloc</span></span>() &#123;</span><br><span class="line">  ls-12418 [000] 85558.075365: funcgraph_entry:                   |          <span class="function"><span class="title">_cond_resched</span></span>() &#123;</span><br><span class="line">  ls-12418 [000] 85558.075365: funcgraph_entry:        0.074 us   |            rcu_all_qs();</span><br><span class="line">  ls-12418 [000] 85558.075366: funcgraph_exit:         1.143 us   |          &#125;</span><br><span class="line">  ls-12418 [000] 85558.075366: funcgraph_entry:        0.064 us   |          should_failslab();</span><br><span class="line">  ls-12418 [000] 85558.075367: funcgraph_entry:        0.075 us   |          prefetch_freepointer();</span><br><span class="line">  ls-12418 [000] 85558.075368: funcgraph_entry:        0.085 us   |          memcg_kmem_put_cache();</span><br><span class="line">  ls-12418 [000] 85558.075369: funcgraph_exit:         4.447 us   |        &#125;</span><br><span class="line">  ls-12418 [000] 85558.075369: funcgraph_entry:                   |        <span class="function"><span class="title">__check_object_size</span></span>() &#123;</span><br><span class="line">  ls-12418 [000] 85558.075370: funcgraph_entry:        0.132 us   |          __virt_addr_valid();</span><br><span class="line">  ls-12418 [000] 85558.075370: funcgraph_entry:        0.093 us   |          __check_heap_object();</span><br><span class="line">  ls-12418 [000] 85558.075371: funcgraph_entry:        0.059 us   |          check_stack_object();</span><br><span class="line">  ls-12418 [000] 85558.075372: funcgraph_exit:         2.323 us   |        &#125;</span><br><span class="line">  ls-12418 [000] 85558.075372: funcgraph_exit:         8.411 us   |      &#125;</span><br><span class="line">  ls-12418 [000] 85558.075373: funcgraph_exit:         9.195 us   |    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">perf probe --add do_sys_open</span><br><span class="line">Added new event:</span><br><span class="line">  probe:do_sys_open    (on do_sys_open)</span><br><span class="line">You can now use it <span class="keyword">in</span> all perf tools, such as:</span><br><span class="line">    perf record -e probe:do_sys_open -aR <span class="built_in">sleep</span> 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">perf probe -V do_sys_open</span><br><span class="line">Available variables at do_sys_open</span><br><span class="line">        @&lt;do_sys_open+0&gt;</span><br><span class="line">                char*   filename</span><br><span class="line">                int     dfd</span><br><span class="line">                int     flags</span><br><span class="line">                struct open_flags     op</span><br><span class="line">                umode_t mode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete probe</span></span><br><span class="line">perf probe --del probe:do_sys_open</span><br><span class="line"></span><br><span class="line">perf probe --add <span class="string">&#x27;do_sys_open filename:string&#x27;</span></span><br><span class="line">Added new event:</span><br><span class="line">  probe:do_sys_open    (on do_sys_open with filename:string)</span><br><span class="line">You can now use it <span class="keyword">in</span> all perf tools, such as:</span><br><span class="line">    perf record -e probe:do_sys_open -aR <span class="built_in">sleep</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># run</span></span><br><span class="line">perf record -e probe:do_sys_open -aR <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># result</span></span><br><span class="line">perf script</span><br><span class="line">   perf 13593 [000] 91846.053622: probe:do_sys_open: (ffffffffa807b290) filename_string=<span class="string">&quot;/proc/13596/status&quot;</span></span><br><span class="line">   <span class="built_in">ls</span> 13596 [000] 91846.053995: probe:do_sys_open: (ffffffffa807b290) filename_string=<span class="string">&quot;/etc/ld.so.cache&quot;</span></span><br><span class="line">   <span class="built_in">ls</span> 13596 [000] 91846.054011: probe:do_sys_open: (ffffffffa807b290) filename_string=<span class="string">&quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;</span></span><br><span class="line">   <span class="built_in">ls</span> 13596 [000] 91846.054066: probe:do_sys_open: (ffffffffa807b290) filename_string=<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6”</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># delete probe before leave</span></span><br><span class="line">perf probe --del probe:do_sys_open</span><br><span class="line"></span><br><span class="line"><span class="comment"># starce is based on ptrace</span></span><br><span class="line">strace <span class="built_in">ls</span></span><br><span class="line">...</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">...</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># perf trace is light</span></span><br><span class="line">perf trace <span class="built_in">ls</span></span><br><span class="line">         ? (         ): <span class="built_in">ls</span>/14234  ... [continued]: execve()) = 0</span><br><span class="line">     0.177 ( 0.013 ms): <span class="built_in">ls</span>/14234 brk(                                                                  ) = 0x555d96be7000</span><br><span class="line">     0.224 ( 0.014 ms): <span class="built_in">ls</span>/14234 access(filename: 0xad98082                                            ) = -1 ENOENT No such file or directory</span><br><span class="line">     0.248 ( 0.009 ms): <span class="built_in">ls</span>/14234 access(filename: 0xad9add0, mode: R                                   ) = -1 ENOENT No such file or directory</span><br><span class="line">     0.267 ( 0.012 ms): <span class="built_in">ls</span>/14234 openat(dfd: CWD, filename: 0xad98428, flags: CLOEXEC                  ) = 3</span><br><span class="line">     0.288 ( 0.009 ms): <span class="built_in">ls</span>/14234 fstat(fd: 3&lt;/usr/lib/locale/C.UTF-8/LC_NAME&gt;, statbuf: 0x7ffd2015f230 ) = 0</span><br><span class="line">     0.305 ( 0.011 ms): <span class="built_in">ls</span>/14234 mmap(len: 45560, prot: READ, flags: PRIVATE, fd: 3                    ) = 0x7efe0af92000</span><br><span class="line">     0.324 Dockerfile  test.sh</span><br><span class="line">( 0.008 ms): <span class="built_in">ls</span>/14234 close(fd: 3&lt;/usr/lib/locale/C.UTF-8/LC_NAME&gt;                          ) = 0</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101221820.png"></p>
<h2 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">netstat -s | grep socket</span><br><span class="line">    73 resets received <span class="keyword">for</span> embryonic SYN_RECV sockets</span><br><span class="line">    308582 TCP sockets finished time <span class="built_in">wait</span> <span class="keyword">in</span> fast timer</span><br><span class="line">    8 delayed acks further delayed because of locked socket</span><br><span class="line">    290566 <span class="built_in">times</span> the listen queue of a socket overflowed</span><br><span class="line">    290566 SYNs to LISTEN sockets dropped</span><br><span class="line"></span><br><span class="line">ss -ltnp</span><br><span class="line">State     Recv-Q     Send-Q            Local Address:Port            Peer Address:Port</span><br><span class="line">LISTEN    10         10                      0.0.0.0:80                   0.0.0.0:*         <span class="built_in">users</span>:((&quot;nginx&quot;,pid=<span class="number">10491</span>,fd=<span class="number">6</span>),(&quot;nginx&quot;,pid=<span class="number">10490</span>,fd=<span class="number">6</span>),(&quot;nginx&quot;,pid=<span class="number">10487</span>,fd=<span class="number">6</span>))</span><br><span class="line">LISTEN    7          10                            *:9000                       *:*         <span class="built_in">users</span>:((&quot;php-fpm&quot;,pid=<span class="number">11084</span>,fd=<span class="number">9</span>),...,(&quot;php-fpm&quot;,pid=<span class="number">10529</span>,fd=<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line">sysctl net.ipv4.ip_local_port_range</span><br><span class="line">net.ipv4.ip_local_port_range=20000 20050</span><br><span class="line"></span><br><span class="line">sysctl -w net.ipv4.ip_local_port_range=<span class="string">&quot;10000 65535&quot;</span></span><br><span class="line">net.ipv4.ip_local_port_range = 10000 65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># timewait is still use port, can decrase timewait time or port reuse</span></span><br><span class="line">ss -s</span><br><span class="line">TCP:   32775 (estab 1, closed 32768, orphaned 0, synrecv 0, timewait 32768/0), ports 0</span><br><span class="line"></span><br><span class="line">sysctl net.ipv4.tcp_tw_reuse</span><br><span class="line">net.ipv4.tcp_tw_reuse = 0</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101222832.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101222835.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101222947.png"></p>
<h2 id="learn-kernel"><a href="#learn-kernel" class="headerlink" title="learn kernel"></a>learn kernel</h2><ol>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source">kernel</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc">eBPF</a></li>
</ol>
<h1 id="Additions"><a href="#Additions" class="headerlink" title="Additions"></a>Additions</h1><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224237.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224240.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224243.png"><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200101224245.png"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/tools/" rel="tag"># tools</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/bigdata/" rel="prev" title="大数据学习笔记">
      <i class="fa fa-chevron-left"></i> 大数据学习笔记
    </a></div>
      <div class="post-nav-item">
    <a href="/post/reviews-2019/" rel="next" title="2019 Reviews">
      2019 Reviews <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#reference"><span class="nav-number">1.</span> <span class="nav-text">reference</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CPU"><span class="nav-number">2.</span> <span class="nav-text">CPU</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#stress-sysstat"><span class="nav-number">2.1.</span> <span class="nav-text">stress sysstat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#context-switch"><span class="nav-number">2.2.</span> <span class="nav-text">context switch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cpu-utilization"><span class="nav-number">2.3.</span> <span class="nav-text">cpu utilization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#many-Z-zombie-state"><span class="nav-number">2.4.</span> <span class="nav-text">many Z (zombie) state</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#soft-interrupt"><span class="nav-number">2.5.</span> <span class="nav-text">soft interrupt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#summary"><span class="nav-number">2.6.</span> <span class="nav-text">summary</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Memory"><span class="nav-number">3.</span> <span class="nav-text">Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#buffer-amp-cache"><span class="nav-number">3.1.</span> <span class="nav-text">buffer &amp; cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#memory-leak"><span class="nav-number">3.2.</span> <span class="nav-text">memory leak</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#swap"><span class="nav-number">3.3.</span> <span class="nav-text">swap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#summary-1"><span class="nav-number">3.4.</span> <span class="nav-text">summary</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#I-O"><span class="nav-number">4.</span> <span class="nav-text">I-O</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#check-io"><span class="nav-number">4.1.</span> <span class="nav-text">check io</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#write-issue"><span class="nav-number">4.2.</span> <span class="nav-text">write issue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#io-wait-issue"><span class="nav-number">4.3.</span> <span class="nav-text">io_wait issue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sql-slow"><span class="nav-number">4.4.</span> <span class="nav-text">sql slow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slow-redis"><span class="nav-number">4.5.</span> <span class="nav-text">slow redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#summary-2"><span class="nav-number">4.6.</span> <span class="nav-text">summary</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Network"><span class="nav-number">5.</span> <span class="nav-text">Network</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#basic-command"><span class="nav-number">5.1.</span> <span class="nav-text">basic command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C10K-and-C1000K"><span class="nav-number">5.2.</span> <span class="nav-text">C10K and C1000K</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performance-test"><span class="nav-number">5.3.</span> <span class="nav-text">performance test</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS-slow"><span class="nav-number">5.4.</span> <span class="nav-text">DNS slow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dump-traffic"><span class="nav-number">5.5.</span> <span class="nav-text">dump traffic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#anti-DDoS"><span class="nav-number">5.6.</span> <span class="nav-text">anti-DDoS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#network-slow"><span class="nav-number">5.7.</span> <span class="nav-text">network slow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT"><span class="nav-number">5.8.</span> <span class="nav-text">NAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#important"><span class="nav-number">5.9.</span> <span class="nav-text">important</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#summary-3"><span class="nav-number">5.10.</span> <span class="nav-text">summary</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Best-Practice"><span class="nav-number">6.</span> <span class="nav-text">Best Practice</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker"><span class="nav-number">6.1.</span> <span class="nav-text">docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#packet-loss"><span class="nav-number">6.2.</span> <span class="nav-text">packet loss</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Tracing"><span class="nav-number">6.3.</span> <span class="nav-text">Dynamic Tracing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#socket"><span class="nav-number">6.4.</span> <span class="nav-text">socket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#monitor"><span class="nav-number">6.5.</span> <span class="nav-text">monitor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#learn-kernel"><span class="nav-number">6.6.</span> <span class="nav-text">learn kernel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Additions"><span class="nav-number">7.</span> <span class="nav-text">Additions</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="feiyang"
      src="/images/feiy.gif">
  <p class="site-author-name" itemprop="name">feiyang</p>
  <div class="site-description" itemprop="description">南洋打工人</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/feiyang233" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;feiyang233" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:feiyang.sg@gmail.com" title="E-Mail → mailto:feiyang.sg@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.apple.com/sg/newsroom/" title="https:&#x2F;&#x2F;www.apple.com&#x2F;sg&#x2F;newsroom&#x2F;" rel="noopener" target="_blank">Apple</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://engineering.grab.com/" title="https:&#x2F;&#x2F;engineering.grab.com&#x2F;" rel="noopener" target="_blank">Grab</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wsgzao.github.io/" title="https:&#x2F;&#x2F;wsgzao.github.io&#x2F;" rel="noopener" target="_blank">奥哥</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">feiyang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://feiyang.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://feiyang233.club/post/linux/";
    this.page.identifier = "post/linux/";
    this.page.title = "Linux performance optimization";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://feiyang.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
